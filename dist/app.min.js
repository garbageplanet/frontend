var api={server:"https://garbagepla.net:8443/api",createUser:{method:"POST",url:function(){return api.server+"/register"}},createLogin:{method:"POST",url:function(){return api.server+"/authenticate"}},readUser:{method:"GET",url:function(){return api.createLogin.url()+"/user"}},removeUser:{method:"DELETE",url:function(){return api.createLogin.url()+"/delete"}},logoutUser:{method:"GET",url:function(){return api.createLogin.url()+"/logout"}},createSoftAccount:{method:"POST",url:function(){return api.server+"/glome/create"}},readSoftAccount:{method:"GET",url:function(id){return api.server+"/glome/show/"+id}},createTrash:{method:"POST",url:function(id){return api.readTrash.url()}},readTrash:{method:"GET",url:function(){return api.server+"/trashes"}},showTrash:{method:"GET",url:function(id){return api.readTrash.url()+"/"+id}},editTrash:{method:"PUT",url:function(){return api.readTrash.url()}},deleteTrash:{method:"DELETE",url:function(id){return api.readTrash.url()+"/"+id}},confirmTrash:{url:function(id){return api.readTrash.url()+"/confirm/"+id}},readTrashWithinBounds:{method:"GET",url:function(currentBounds){return api.readTrash.url()+"/withinbounds?bounds="+currentBounds}},createCleaning:{method:"POST",url:function(id){return api.readCleaning.url()}},readCleaning:{method:"GET",url:function(){return api.server+"/cleanings"}},showCleaning:{method:"GET",url:function(id){return api.readCleaning.url()+"/"+id}},editCleaning:{method:"PUT",url:function(id){return api.readCleaning.url()+"/"+id}},deleteCleaning:{method:"DELETE",url:function(id){return api.readCleaning.url()+"/"+id}},readCleaningWithinBounds:{method:"GET",url:function(currentBounds){return api.readCleaning.url()+"/withinbounds?bounds="+currentBounds}},attendCleaning:{url:function(id){return api.readCleaning.url()+"/attend/"+id}},readLitterWithinBounds:{method:"GET",url:function(currentBounds){return api.readLitter.url()+"/withinbounds?bounds="+currentBounds}},createLitter:{method:"POST",url:function(){return api.readLitter.url()}},readLitter:{method:"GET",url:function(){return api.server+"/litters"}},showLitter:{method:"GET",url:function(id){return api.readLitter.url()+"/"+id}},deleteLitter:{method:"DELETE",url:function(id){return api.readLitter.url()+"/"+id}},confirmLitter:{url:function(id){return api.readLitter.url()+"/confirm/"+id}},readAreaWithinBounds:{method:"GET",url:function(currentBounds){return api.readArea.url()+"/withinbounds?bounds="+currentBounds}},createArea:{method:"POST",url:function(){return api.readArea.url()}},readArea:{method:"GET",url:function(){return api.server+"/areas"}},showArea:{method:"GET",url:function(id){return api.readArea.url()+"/"+id}},deleteArea:{method:"DELETE",url:function(id){return api.readArea.url()+"/"+id}}};$(document).ready(function(){if(window.innerWidth<768){$("#topbar").remove();$("body").append('<div class="swipe-area swipe-area-right"></div>');$("#sidebar").append('<div class="swipe-area swipe-area-left"></div>');$("#bottombar").prepend('<div class="swipe-area swipe-area-top"></div>');$(".draw-link").addClass("disabled");$(".garbage-type-select, .litter-type-select").attr("data-live-search","false");$(".swipe-area-right").touchwipe({wipeLeft:function(){sidebar.show($("#mobile-menu-dialog").show())},min_move_x:15,preventDefaultEvents:true});$(".swipe-area-left").touchwipe({wipeRight:function(){sidebar.hide()},min_move_x:15,preventDefaultEvents:true});$(".swipe-area-top").touchwipe({wipeUp:function(){bottombar.hide()},min_move_y:20,preventDefaultEvents:true})}});var templatedata={social:{network:[{iconclass:"fa-facebook",btnclass:"btn-facebook",title:"Share on Facebook",targeturl:""},{iconclass:"fa-twitter",btnclass:"btn-twitter",title:"Share on Twitter",targeturl:""},{iconclass:"fa-google-plus",btnclass:"btn-google-plus",title:"Share on Google+",targeturl:""},{iconclass:"fa-reddit fa-lg fa-icon-centered",btnclass:"btn-reddit",title:"Share on Reddit",targeturl:""},{iconclass:"fa-tumblr",btnclass:"btn-tumblr",title:"Share on Tumblr",targeturl:""},{iconclass:"fa-vk fa-icon-centered",btnclass:"btn-vk",title:"Share on V-Kontakti",targeturl:""},{iconclass:"fa-whatsapp fa-lg fa-icon-centered",btnclass:"btn-whatsapp",title:"Share on Whatsapp",targeturl:""},{iconclass:"fa-renren fa-lg fa-icon-centered",btnclass:"btn-renren",title:"Share on RenRen",targeturl:""}]},credits:[{title:"homepage",linkurl:"http://home.garbagepla.net/",text:"Project"},{title:"Let's Encrypt",linkurl:"https://letsencrypt.org/",text:"Secured with"},{title:"Mapbox",linkurl:"https://www.mapbox.com/",text:"Basemaps imagery ©"},{title:"Openstreetmap and contributors",linkurl:"http://www.openstreetmap.org/",text:"Maps and underlying data ©"},{title:"Overpass API",linkurl:"http://www.overpass-api.de/",text:"POIs retrieved using the"},{title:"OpenCage Geocoder",linkurl:"https://geocoder.opencagedata.com/",text:"Address search and geocoding"},{title:"Leaflet",linkurl:"http://leafletjs.com/",text:"Mapping done with "},{title:"FontAwesome",linkurl:"http://fontawesome.io/",text:"Icons by"},{title:"Bootstrap 3",linkurl:"http://getbootstrap.com/",text:"Built with"},{title:"JQuery",linkurl:"https://jquery.com/",text:"Runs on"},{title:"Laravel 5.1",linkurl:"https://laravel.com/",text:"Backed by"},{title:"JavaScript-Templates",linkurl:"https://github.com/blueimp/JavaScript-Templates",text:"Templating with"},{title:"Github",linkurl:"https://github.com/garbageplanet",text:"Source code available on"}],garbagetypes:{value:["plastic","bags","pet","poly","butts","foodpacks","party","fastfood","glassshard","glass","bottles","metal","tin","alu","wood","chemicals","household","clothes","fabric","matress","tarp","electronic","electric","industrial","construction","gas","crude","vehicle","bicycle","motorcyle","tyres","engine","parts","fishing","commercial","net","lines","boat","vessel","boating","buoy","maritime"],name:["Plastic items","Plastic bags","PET bottles","Expanded plastic polymers","Cigarette butts","Plastic food containers","Party leftovers","Fastfood garbage","Broken glass","Glass","Glass bottles","Metal","Tin cans","Aluminium cans","Plywood, treated/painted wood","Chemicals","Household garbage","Shoes and clothes","Carpets and fabrics","Matresses","Tarps, other large covers","Electronics","Electric appliances, batteries","Industrial wastes","Construction wastes","Gasoline, petroleum oil","Crude oil","Large vehicle","Bicycles","Motorcycles","Tyres","Engine parts","Vehicles parts","Fishing gears","Commercial fishing equipment","Fishing net","Fishing line","Small boat","Large boat, wreck","Boating equipment","Buoys and floats","Maritime equipment"]}};(function($){"use strict";var tmpl=function(id,data){var f=tmpl.cache[id];return data?f(data,tmpl):function(data){return f(data,tmpl)}};tmpl.cache={"tmpl-credits":function(o,tmpl){var _e=tmpl.encode,_s="\n";for(var i=0;i<o.credits.length;i++){_s+="\n"+_e(o.credits[i].text)+' <a href="'+_e(o.credits[i].linkurl)+'">'+_e(o.credits[i].title)+"</a><br>\n"}_s+="\n";return _s},"tmpl-feature-info":function(o,tmpl){var _e=tmpl.encode,_s='\n<div class="row row-horizon bottombar-content" id="feature-info">\n<div class="card card-actions col-xl-1 col-lg-1 col-md-1 col-ms-1 col-sm-2 col-xs-2">\n<div>\n<div class="btn-group-vertical" role="group">\n<div class="btn-group btn-group-lg" role="group">\n<button type="button" title="Edit this feature" class="btn btn-warning btn-edit btn-round sidebar-link">\n<span class="fa fa-pencil"></span>\n</button>\n</div>\n<div class="btn-group btn-group-lg hidden-xs" role="group">\n<button type="button" title="Delete this feature" class="btn btn-danger btn-round btn-delete">\n<span class="fa fa-times"></span>\n</button>\n</div>\n';if(o.amount){_s+='\n<div class="btn-group btn-group-lg" role="group">\n<button type="button" title="The garbage has been cleaned" class="btn btn-round btn-success btn-cleaned">\n<span class="fa fa-check"></span>\n</button>\n</div>\n'}_s+="\n";if(o.amount){_s+='\n<div class="btn-group btn-group-lg" role="group">\n<button type="button" title="Confirm there is garbage here" class="btn btn-round btn-info btn-confirm-garbage">\n<span class="fa fa-binoculars"></span>\n</button>\n<span class="badge badge-notify badge-notify-confirm">'+_e(o.confirms)+"</span>\n</div>\n"}_s+="\n";if(o.datetime){_s+='\n<div class="btn-group btn-group-lg" role="group">\n<button type="button" title="Say you will help" class="btn btn-round btn-info btn-attend-cleaning">\n<span class="fa fa-group"></span>\n</button><span class="badge badge-notify badge-notify-attend">'+_e(o.attends)+"</span>\n</div>\n"}_s+="\n";if(o.contact){_s+='\n<div class="btn-group btn-group-lg" role="group">\n<button type="button" title="Join game" class="btn btn-round btn-info btn-participate-game">\n<span class="fa fa-play"></span>\n</button><span class="badge badge-notify badge-notify-participate">'+_e(o.participant)+"</span>\n</div>\n"}_s+='\n<div class="btn-group btn-group-lg" role="group">\n<button type="button" title="Share this" class="btn btn-round btn-default btn-social" data-toggle="popover" data-placement="top" data-trigger="focus">\n<span class="fa fa-share-alt"></span>\n</button>\n</div>\n</div>\n<div class="hidden" id="social-links"></div>\n</div>\n</div>\n<div class="card card-scroll card-data col-xl-2 col-lg-2 col-md-3 col-ms-3 col-sm-4 col-xs-6">\n<div><h3>Data</h3></div>\n<div class="feature-data-card">\n';if(o.types){_s+='\n<div class="panel panel-default">\n<div class="panel-body">\n<span class="pull-left">type:'+_e(o.types)+'</span>\n<span class="feature-info feature-info-garbage feature-info-litter feature-info-garbage-type pull-left"></span>\n</div>\n</div>\n'}_s+="\n";if(o.amount){_s+='\n<div class="panel panel-default">\n<div class="panel-body">\n<span class="pull-left">amount:'+_e(o.amount)+'</span>\n<span class="feature-info feature-info-garbage feature-info-litter feature-info-garbage-amount pull-left"></span>\n</div>\n</div>\n'}_s+="\n";if(o.size){_s+='\n<div class="panel panel-default">\n<div class="panel-body">\n<span class="pull-left">sizes:'+_e(o.size)+'</span>\n<span class="feature-info feature-info-garbage feature-info-litter feature-info-garbage-size pull-left"></span>\n</div>\n</div>\n'}_s+="\n";if(o.embed){_s+='\n<div class="panel panel-default">\n<div class="panel-body">\n<span class="pull-left">in:'+_e(o.embed)+'</span>\n<span class="feature-info feature-info-garbage feature-info-litter feature-info-garbage-embed pull-left"></span>\n</div>\n</div>\n'}_s+="\n";if(o.physical_length){_s+='\n<div class="panel panel-default">\n<div class="panel-body">\n<span class="pull-left">length:'+_e(o.physical_length)+'</span>\n<span class="feature-info feature-info-garbage feature-info-litter feature-info-litter-length pull-left"></span>\n</div>\n</div>\n'}_s+="\n";if(o.todo){_s+='\n<div class="panel panel-default">\n<div class="panel-body">\n<span class="pull-left">todo:'+_e(o.todo)+'</span>\n<span class="feature-info-garbage feature-info feature-info-todo pull-left"></span>\n</div>\n</div>\n'}_s+="\n";if(o.note){_s+='\n<div class="panel panel-default">\n<div class="panel-body">\n<span class="pull-left">note:'+_e(o.note)+'</span>\n<span class="feature-info feature-info-common feature-info-note pull-left"></span>\n</div>\n</div>\n'}_s+="\n";if(o.tags){_s+='\n<div class="panel panel-default">\n<div class="panel-body">\n<span class="pull-left">note:'+_e(o.tags)+'</span>\n<span class="feature-info feature-info-common feature-info-tags pull-left">\n';for(var i=0;i<o.tags.length;i++){_s+='\n<span class="label label-default">'+_e(o.tags[i])+"</span>\n"}_s+="\n</span>\n</div>\n</div>\n"}_s+="\n";if(o.datetime){_s+='\n<div class="panel panel-default">\n<div class="panel-body">\n<span class="pull-left">time:'+_e(o.datetime)+'</span>\n<span class="feature-info feature-info-cleaning feature-info-time pull-left"></span>\n</div>\n</div>\n'}_s+="\n";if(o.datetime){_s+='\n<div class="panel panel-default">\n<div class="panel-body">\n<span class="pull-left">location:</span>\n<span class="feature-info feature-info-cleaning feature-info-location pull-left"></span>\n</div>\n</div>\n'}_s+="\n";if(o.physical_length){_s+='\n<div class="panel panel-default">\n<div class="panel-body">\n<span class="pull-left">length:'+_e(o.physical_length)+'</span>\n<span class="feature-info feature-info-litter feature-info-length pull-left"></span>\n</div>\n</div>\n'}_s+="\n";if(o.title){_s+='\n<div class="panel panel-default">\n<div class="panel-body">\n<span class="pull-left">name:'+_e(o.title)+'</span>\n<span class="feature-info feature-info-area feature-info-name pull-left"></span>\n</div>\n</div>\n'}_s+="\n";if(o.contact){_s+='\n<div class="panel panel-default">\n<div class="panel-body">\n<span class="pull-left">contact:'+_e(o.contact)+'</span>\n<span class="feature-info feature-info-area feature-info-contact pull-left"></span>\n</div>\n</div>\n<div class="panel panel-default">\n<div class="panel-body">\n<span class="pull-left">players:'+_e(o.players)+'</span>\n<span class="feature-info feature-info-area feature-info-players pull-left"></span>\n</div>\n</div>\n<div class="panel panel-default">\n<div class="panel-body">\n<span class="pull-left">results:<a href="'+_e(o.results_link)+'" class="game-results-modal-link" data-toggle="modal" data-target="#game-results-modal"> click here to view<a/></span>\n<span class="feature-info feature-info-area feature-info-results pull-left"></span>\n</div>\n</div>\n'}_s+="\n</div>\n</div>\n";if(o.image_url){_s+='\n<div class="card card-scroll card-media col-xl-2 col-lg-2 col-md-3 col-ms-3 col-sm-4 col-xs-6">\n<div><h3>Media</h3></div>\n<a class="feature-image-link" href="'+(o.image_url==null?"":o.image_url)+'" target="_blank"><img src="'+(o.image_url==null?"":o.image_url)+'" alt="feature image" class="feature-image center-block"></a>\n</div>\n'}_s+='\n<div class="card card-scroll card-track col-xl-2 col-lg-2 col-md-3 col-ms-3 col-sm-4 col-xs-6">\n<div><h3>Track changes</h3></div>\n<div class="panel panel-default">\n<div class="panel-body">\n<span class="pull-left">creation date:'+_e(o.created_at)+'</span>\n<span class="feature-info feature-info-created-at pull-left"></span>\n</div>\n</div>\n<div class="panel panel-default">\n<div class="panel-body">\n<span class="pull-left">created by:'+_e(o.created_by)+'</span>\n<span class="feature-info feature-info-created-by pull-left"></span>\n</div>\n</div>\n';if(o.modifided_by){_s+='\n<div class="panel panel-default">\n<div class="panel-body">\n<span class="pull-left">modified by:'+_e(o.modifided_by)+'</span>\n<span class="feature-info feature-info-modified-by pull-left"></span>\n</div>\n</div>\n<div class="panel panel-default">\n<div class="panel-body">\n<span class="pull-left">modified at:'+_e(o.modifided_at)+'</span>\n<span class="feature-info feature-info-modified-at pull-left"></span>\n</div>\n</div>\n'}_s+="\n";if(o.cleaned_by){_s+='\n<div class="panel panel-default">\n<div class="panel-body">\n<span class="pull-left">modified by:'+_e(o.cleaned_by)+'</span>\n<span class="feature-info feature-info-cleaned-by pull-left"></span>\n</div>\n</div>\n'}_s+='\n<div class="panel panel-default">\n<div class="panel-body">\n<span class="pull-left"><a class="feature-info-report" href="#">Report</a></span>\n</div>\n</div>\n</div>\n';if(o.date){_s+='\n<div class="card card-minimap col-xl-2 col-lg-2 col-md-3 col-ms-3 col-sm-4 col-xs-6">\n<div><h3>Access minimap</h3></div>\n<div id ="minimap" class="cleaning-minimap-card"></div>\n</div>\n'}_s+="\n</div>\n";return _s},"tmpl-modal-cleaning":function(o,tmpl){var _e=tmpl.encode,_s="\n";for(var i=0;i<o.length;i++){_s+='\n<tr class="modal-calendar-row">\n<td>'+_e(o[i].id)+"</td>\n<td>"+_e(o[i].datetime)+"</td>\n<td>"+_e(o[i].latlng)+"</td>		\n</tr>\n"}_s+="\n";return _s},"tmpl-modal-garbage":function(o,tmpl){var _e=tmpl.encode,_s="\n";for(var i=0;i<o.length;i++){_s+='\n<tr class="modal-data-row">\n<td>'+_e(o[i].id)+"</td>		\n<td>"+_e(o[i].latlng)+"</td>		\n<td>"+_e(o[i].amount)+"</td>\n<td>"+_e(o[i].types)+"</td>\n</tr>\n"}_s+="\n";return _s},"tmpl-social-links":function(o,tmpl){var _e=tmpl.encode,_s="\n";for(var i=0;i<o.social.network.length;i++){_s+='\n<div class="btn-group btn-group-lg" role="group">\n<a href="'+_e(o.social.network[i].targeturl)+'" target="_blank" title="'+_e(o.social.network[i].title)+'" class="btn '+_e(o.social.network[i].btnclass)+' btn-round btn-share"><span class="fa '+_e(o.social.network[i].iconclass)+'"></span></a>\n</div>\n'}_s+="\n";return _s},"tmpl-form-garbage-type":function(o,tmpl){var _e=tmpl.encode,_s="\n";for(var i=0;i<o.garbagetypes.value.length;i++){_s+='\n<option value="'+_e(o.garbagetypes.value[i])+'">'+_e(o.garbagetypes.name[i])+"</option>\n"}_s+="\n";return _s}};tmpl.encReg=/[<>&"'\x00]/g;tmpl.encMap={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&#39;"};tmpl.encode=function(s){return(s==null?"":""+s).replace(tmpl.encReg,function(c){return tmpl.encMap[c]||""})};if(typeof define==="function"&&define.amd){define(function(){return tmpl})}else if(typeof module==="object"&&module.exports){module.exports=tmpl}else{$.tmpl=tmpl}})(this);function login(e){e.preventDefault();var email=$("#login-email").val(),password=$("#login-password").val();$.ajax({type:api.createLogin.method,url:api.createLogin.url(),data:{email:email,password:password},success:function(response){localStorage.setItem("token",response.token);$.ajax({method:api.readUser.method,url:api.readUser.url(),headers:{Authorization:"Bearer "+response.token},success:function(data){$("#user-login-dialog").hide();localStorage.setItem("classic","true");localStorage.setItem("username",data.user.name);localStorage.setItem("userid",data.user.id);localStorage.setItem("useremail",data.user.email);void 0;void 0;switchSession("login");showAlert("Login successful","success",1500)}})},error:function(response){void 0;showAlert("Failed to log in.","danger",2e3);localStorage.removeItem("token")}})}function logout(){if(!localStorage.token){showAlert("No active session.","info",2e3);localStorage.clear()}else{var useToken=localStorage.getItem("token")||window.token;$.ajax({method:api.logoutUser.method,url:api.logoutUser.url(),headers:{Authorization:"Bearer "+useToken},success:function(response){switchSession("logout");showAlert("You are logged out.","info",2e3);localStorage.clear();if(sidebar.isVisible()){sidebar.hide()}},error:function(response){showAlert("Sorry, something went wrong.","danger",2e3)}})}}function checklogin(){var useToken=localStorage.getItem("token")||window.token;$.ajax({method:api.readUser.method,url:api.readUser.url(),headers:{Authorization:"Bearer "+useToken},success:function(data){if(useToken){switchSession("login")}},error:function(data){if(useToken){showAlert("Session expired. Please log in again.","danger",2e3);switchSession("logout");localStorage.clear();sidebar.show($("#user-login-dialog").show().siblings().hide())}}})}function registerUser(e){e.preventDefault();var email=$("#register-email").val(),name=$("#register-name").val(),password=$("#register-password").val();$.ajax({type:api.createUser.method,url:api.createUser.url(),data:{email:email,password:password,name:name},success:function(response){localStorage.setItem("token",response.token);$("#create-account-dialog").hide();$.ajax({method:api.readUser.method,url:api.readUser.url(),headers:{Authorization:"Bearer "+response.token},success:function(data){void 0;localStorage.setItem("classic","true");localStorage.setItem("username",data.user.name);localStorage.setItem("userid",data.user.id);localStorage.setItem("useremail",data.user.email);switchSession("login");showAlert("Registration successful, you are now logged in.","success",2e3)}})},error:function(response){showAlert(response.responseText.substring(2,30),"danger",3500);localStorage.removeItem("token")}})}function glomego(){void 0;$.ajax({type:api.createSoftAccount.method,url:api.createSoftAccount.url(),dataType:"json",success:function(response){var glomeid=response.user.name,authUser=response.user,token=response.token;if(!glomeid||typeof glomeid==="undefined"){showAlert("Failed to login anonymously. Reload the page and try again.","warning",3e3);return}localStorage.setItem("token",token);localStorage.setItem("glomekey",glomeid);localStorage.setItem("userid",response.user.id);$("#user-login-dialog").hide();$.ajax({method:api.readSoftAccount.method,url:api.readSoftAccount.url(glomeid),headers:{Authorization:"Bearer "+token},dataType:"json",success:function(data){void 0;if(!data||typeof data==="undefined"){return}if(typeof authUser!=="undefined"){localStorage.setItem("classic","false");switchSession("login");showAlert("You are now logged in anonymously.","success",2e3)}}})},error:function(response){void 0;showAlert("Failed to login anonymously. Reload the page and try again.","warning",3e3);localStorage.removeItem("token")}})}function sendGlomeKey(e){e.preventDefault();var glomeKey=$("#glome-key").val();$.ajax({type:api.checkGlomeKey.method,url:api.receiveGlomeKey.url(),data:{key:glomeKey},success:function(response){localStorage.setItem("token",response.token);void 0;$("#create-account-dialog").hide();switchSession("login");showAlert("Welcome back, anonymous!.","success",2e3);$.ajax({method:"get",url:"http://api.garbagepla.net/api/authenticate/glome",headers:{Authorization:"Bearer "+response.token},success:function(data){void 0;$("#account-info").find(".user-glome-key p").html(data.user.key);$("#account-info").find(".user-email").addClass("hidden");$("#account-info").find(".created-at").html(data.user.created_at);$("#account-info").find(".updated-at").html(data.user.updated_at);$("#account-info").show()}})},error:function(response){void 0;showAlert("Sorry. Key not recognized.","danger",3e3);localStorage.removeItem("token")}})}function deleteUser(e){var classicSessionType=localStorage.getItem("classic");if(classicSessionType==="true"){void 0;e.preventDefault();var useToken=localStorage.getItem("token"),email=localStorage.getItem("useremail"),password=$("#delete-password").val();$.ajax({method:api.removeUser.method,url:api.removeUser.url(),headers:{Authorization:"Bearer "+useToken},data:{email:email,password:password},success:function(data){switchSession("logout");showAlert("Account successfully deleted.","success",2e3);localStorage.clear()},error:function(response){sidebar.hide();showAlert("Sorry, something went wrong.","danger",2e3)}})}else{showAlert("You cannot delete soft accounts.","warning",2e3)}}$(function(){$(".btn-logout").on("click",logout);$(".btn-login").click(login);$("#registration-form").submit(registerUser);$(".btn-glome-go").on("click",glomego);$(".btn-glome-key-send").click(sendGlomeKey);$(".btn-delete-account").one("click",deleteUser)});function switchSession(sessionStatus){var classicSessionType=localStorage.getItem("classic");if(sessionStatus==="logout"){if(window.innerWidth<568){logincontrol.logout()}$("#session-status a").text("Login").attr("href","#user-login-dialog");$("#session-status a").attr("id","");$("#session-status a").addClass("dropdown-link");$("#user-info-link").remove();$("#user-info-mobile-link").remove();$("#user-tools").dropdown();$(".user-email, .user-glome-key").removeClass("hidden");$(".session-link").removeClass("hidden")}if(sessionStatus==="login"){if(window.innerWidth<568){logincontrol.login()}$("#session-status a").text("Logout").attr("href","#");$("#session-status a").attr("id","btn-logout");$("#session-status a").removeClass("dropdown-link");$("#session-status").on("click","#btn-logout",function(){switchSession("logout");logout()});$("#user-tools").prepend('<li id="user-info-link"><a class="dropdown-link" href="#account-info">User info</a></li>');$("#user-info-link a").on("click",function(e){e.preventDefault();$("#sidebar").scrollTop=0;$(this.hash).fadeIn().siblings().hide();sidebar.show()});$(".mobile-menu").append('<a href="#account-info" id="user-info-mobile-link" class="sidebar-link btn btn-default btn-lg btn-block"><span class="fa fa-fw fa-user"></span> User info</a>');$("#user-info-mobile-link").on("click",function(e){e.preventDefault();$("#sidebar").scrollTop=0;$(this.hash).fadeIn().siblings().hide()});$("#user-tools").dropdown();$(".session-link").addClass("hidden");if(classicSessionType==="true"){$("#account-info").find(".user-email").removeClass("hidden");$("#account-info").find(".user-name").text(localStorage.getItem("username"));$("#account-info").find(".user-email p").html(localStorage.getItem("useremail"));$("#account-info").find(".user-glome-key").addClass("hidden");$("#account-info").find(".user-id").html(localStorage.getItem("userid"));$(".sidebar-content").hide();if(!sidebar.isVisible()){sidebar.show()}$("#account-info").show()}if(classicSessionType==="false"){$("#account-info").find(".user-name").text("anon (⌐■_■)");$("#account-info").find(".user-email").addClass("hidden");$("#account-info").find(".user-glome-key p").html(localStorage.getItem("glomekey").ellipsis(30));$("#account-info").find(".user-id").html(localStorage.getItem("userid"));$(".sidebar-content").hide();if(!sidebar.isVisible()){sidebar.show()}$("#account-info").show()}}}$(document).ready(function(){if(localStorage.getItem("token")){checklogin()}else{return}});function showAlert(errorMessage,errorType,closeDelay){if(!errorType||typeof errorType==="undefined"){var errorType="info"}var alert=$('<div class="alert alert-'+errorType+' fade in">').append(errorMessage);$(".alert-container").prepend(alert);if(closeDelay){window.setTimeout(function(){alert.alert("close")},closeDelay)}}function showErrorType(e){var errortype;if(e.status===200){errortype=showAlert("Sorry, something went wrong with the server","danger",2500)}else if(e.status==="error"){errortype=showAlert("The request was not handled properly by the server","danger",2500)}else if(e.status===401||e.status===400){errortype=showAlert("Sorry, are you logged in?","danger",2500)}else{errortype=showAlert("Something went wrong, HTTP error "+e.status,"danger",2500)}return errortype}var map=L.map("map",{zoomControl:false,attributionControl:true});var hash=new L.Hash(map);var baselayer={"Mapbox Outdoors":L.tileLayer("https://api.tiles.mapbox.com/v4/adriennn.9da931dd/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiYWRyaWVubm4iLCJhIjoiNWQ5ZTEwYzE0MTY5ZjcxYjIyNmExZDA0MGE2MzI2YWEifQ.WGCZQzbVhF87_Z_Yo1aMIQ",{maxZoom:18,reuseTiles:true,attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a>, Imagery &copy; <a href="http://mapbox.com">Mapbox</a>'}),"Mapbox Satellite":L.tileLayer("https://api.tiles.mapbox.com/v4/adriennn.nej0l93m/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiYWRyaWVubm4iLCJhIjoiNWQ5ZTEwYzE0MTY5ZjcxYjIyNmExZDA0MGE2MzI2YWEifQ.WGCZQzbVhF87_Z_Yo1aMIQ",{maxZoom:18,reuseTiles:true,attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a>, Imagery &copy; <a href="http://mapbox.com">Mapbox</a>'})};baselayer["Mapbox Outdoors"].addTo(map);var sidebar=L.control.sidebar("sidebar",{position:"right",closebutton:"true"});map.addControl(sidebar);var bottombar=L.control.sidebar("bottombar",{position:"bottom",closebutton:"true"});map.addControl(bottombar);var garbageLayerGroup=new L.LayerGroup,areaLayerGroup=new L.FeatureGroup,litterLayerGroup=new L.FeatureGroup,cleaningLayerGroup=new L.LayerGroup,allLayers=new L.LayerGroup([garbageLayerGroup,areaLayerGroup,cleaningLayerGroup,litterLayerGroup]);map.addLayer(garbageLayerGroup,cleaningLayerGroup,litterLayerGroup,areaLayerGroup);var overlayGroups={"Garbage markers":garbageLayerGroup,"Cleaning events":cleaningLayerGroup,"Littered coasts and roads":litterLayerGroup,"Tiles and areas":areaLayerGroup};if(window.innerWidth>568){map.addControl(L.control.zoom({position:"topleft"}))}var locationcontrol=L.control.locate().addTo(map);if(!window.location.href.match(/[-+]?([1-8]?\d(\.\d+)?|90(\.0+)?)\/*[-+]?(180(\.0+)?|((1[0-7]\d)|([1-9]?\d))(\.\d+)?)/)){locationcontrol.start()}function onLocationFound(e){map.setView(e.latlng,18)}function onLocationError(e){showAlert("Couldn't find your position.","warning",2e3);if(window.location.href.match(/[-+]?([1-8]?\d(\.\d+)?|90(\.0+)?)\/*[-+]?(180(\.0+)?|((1[0-7]\d)|([1-9]?\d))(\.\d+)?)/)){locationcontrol.stop()}else{map.setView([0,0],2)}}map.on("locationerror",onLocationError);map.on("locationfound",onLocationFound);L.control.scale({metric:true,imperial:false}).addTo(map);L.control.layers(baselayer,overlayGroups).setPosition("topleft").addTo(map);var opencageoptions={key:"2bb5bf0d3b9300eacceb225f3cf9cd7d",limit:5};var geocoder=L.Control.OpenCageSearch.geocoder(opencageoptions);var geocodercontrol=new L.Control.openCageSearch(opencageoptions).setPosition("topleft").addTo(map);$(".leaflet-control-layers-toggle").append("<span class='fa fa-2x fa-globe fa-icon-control-centered'></span>");if(window.innerWidth<568){var logincontrol=L.control.login().addTo(map)}map.doubleClickZoom.disable();var mapMarker=L.DivIcon.extend({options:{iconSize:[30,30],className:"map-marker",html:'<i class="fa fa-fw"></i>'}});var genericMarker=new mapMarker({className:"map-marker marker-color-gray marker-generic"}),garbageMarker=new mapMarker({className:"map-marker marker-garbage"}),cleaningMarker=new mapMarker({className:"map-marker marker-cleaning"}),dieoffMarker=new mapMarker({className:"map-marker marker-dieoff"}),sewageMarker=new mapMarker({className:"map-marker marker-sewage"}),floatingMarker=new mapMarker({className:"map-marker marker-floating"});$(document).ready(function(){$("#user-tools").on("click","a",function(e){if($(this).hasClass("dropdown-link")){e.preventDefault();bottombar.hide();sidebar.show();$(this.hash).fadeIn().siblings().hide()}});$("#btn-trashbins").on("click",function(){osmTrashbinLayer=new L.OverPassLayer({query:'(node["amenity"="waste_basket"]({{bbox}});node["amenity"="recycling"]({{bbox}});node["amenity"="waste_disposal"]({{bbox}}););out;'});map.addLayer(osmTrashbinLayer)})});$(document).ready(function(){if(window.innerWidth>=768){$("#mobile-menu-dialog").remove()}});String.prototype.ellipsis=function(n){return this.substr(0,n-1)+(this.length>n?"&hellip;":"")};$(".sidebar-link").click(function(e){e.preventDefault();$(this.hash).fadeIn().siblings().hide();$("#sidebar").scrollTop=0});$(".menu-backlink").click(function(e){$(".panel-collapse").collapse("hide");$("#sidebar").scrollTop=0;$(this.hash).fadeIn().siblings().hide();e.preventDefault()});$(".btn-cancel").on("click",function(){sidebar.hide();map.removeLayer(marker)});sidebar.on("hide",function(){$(".sidebar-content").hide();$(".sidebar-container",".sidebar-content").scrollTop=0;$("form").each(function(){this.reset()});$("input").val("");$(".selectpicker").selectpicker("render");$(".tab-default").tab("show");$(".leaflet-draw-edit-edit").removeClass("visible");$(".leaflet-draw-edit-remove").removeClass("visible")});document.getElementById("credits").innerHTML=tmpl("tmpl-credits",templatedata);document.getElementById("garbage-select").innerHTML=tmpl("tmpl-form-garbage-type",templatedata);document.getElementById("litter-select").innerHTML=tmpl("tmpl-form-garbage-type",templatedata);function pushDataToBottomPanel(e){var featuredata=e.options;if(!featuredata){featuredata=e}String.prototype.insert=function(index,string){if(index>0){return this.substring(0,index)+string+this.substring(index,this.length)}else{return string+this}};document.getElementById("bottombar-content-container").innerHTML=tmpl("tmpl-feature-info",featuredata);shareThisFeature(featuredata);document.getElementById("social-links").innerHTML=tmpl("tmpl-social-links",templatedata);bottombar.show($("#feature-info").fadeIn());if(featuredata.image_url){var image_url_insert=featuredata.image_url.insert(26,"b");$("#feature-info").find(".feature-image").attr("src",image_url_insert)}$("#feature-info").find(".btn-edit").on("click",function(){if(localStorage.getItem("token")){editFeature(featuredata)}else{showAlert("Please login to do that.","warning",2e3)}});$("#feature-info").find(".btn-cleaned").on("click",function(){cleanedGarbage(featuredata)});$("#feature-info").find(".btn-confirm-garbage").on("click",function(){confirmGarbage(featuredata);
});$("#feature-info").find(".btn-attend-cleaning").on("click",function(){attendCleaning(featuredata)});$("#feature-info").find(".btn-participate-game").on("click",function(){participateGame(featuredata)});$(".btn-social").popover({html:true,container:"body",placement:function(pop){if(window.innerWidth<560){return"top"}else{return"right"}},content:function(){return $("#social-links").html()},template:'<div class="popover popover-share" role="tooltip"><div class="popover-content popover-share"></div></div>'});$(".game-results-modal-link").on("click",function(){var user_id=localStorage.getItem["userid"],game_list={};if(user_id in game_list){var gameResults=tmpl("tmpl-game-results",gamedata);$("body").append(gameResults)}else{showAlert("Sorry. You are not on the players list, you can't look at this data.","warning",2e3);return}});$("#feature-info").find(".btn-delete").on("click",function(e){void 0;e.preventDefault();if(featuredata.feature_type){switch(featuredata.feature_type){case"marker_cleaning":var deletemethod=api.deleteCleaning.method;var deleteurl=api.deleteCleaning.url(featuredata.id);break;case"polyline_litter":var deletemethod=api.deleteLitter.method;var deleteurl=api.deleteLitter.url(featuredata.id);break;case"polygon_area":var deletemethod=api.deleteArea.method;var deleteurl=api.deleteArea.url(featuredata.id);break;case"marker_garbage":var deletemethod=api.deleteTrash.method;var deleteurl=api.deleteTrash.url(featuredata.id);break}var useToken=localStorage.getItem("token")||window.token;if((featuredata.marked_by||featuredata.created_by)==localStorage.getItem("userid")){$.ajax({type:deletemethod,url:deleteurl,headers:{Authorization:"Bearer "+useToken},success:function(response){bottombar.hide();loadGarbageMarkers();loadCleaningMarkers();loadLitters();loadAreas();showAlert("Feature deleted successfully!","success",1500)},error:function(response){void 0;showAlert("Failed to remove this feature.","warning",2e3)}})}else{bottombar.hide();showAlert("You cannot delete features you did not create.","danger",2500)}}})}bottombar.on("hide",function(){$(".btn-social").popover("destroy");$(".modal").modal("hide").data("bs.modal",null)});var garbageArray=[];var cleaningArray=[];function getCurrentBounds(){var currentViewBounds=map.getBounds().toBBoxString();return currentViewBounds}map.on("dragend zoomend",function(e){if(e.type==="zoomend"){garbageArray=[];cleaningArray=[];if(e.target.getZoom()>=8){loadGarbageMarkers();loadCleaningMarkers();if(e.target.getZoom()<=16){loadLitters();loadAreas()}}if(e.target.getZoom()<7){areaLayerGroup.clearLayers();litterLayerGroup.clearLayers()}}if(e.type==="dragend"){if(e.distance>=window.innerWidth/3){garbageArray=[];cleaningArray=[];if(e.target.getZoom()>=8){loadGarbageMarkers();loadCleaningMarkers();if(e.target.getZoom()>=8&&e.target.getZoom()<=16){loadLitters();loadAreas()}}}}});function loadGarbageMarkers(){setTimeout(function(){garbageLayerGroup.clearLayers();var useToken=localStorage.getItem("token")||window.token;$.ajax({type:api.readTrashWithinBounds.method,url:api.readTrashWithinBounds.url(getCurrentBounds()),success:function(data){function setClassColor(c){return c===1?"marker-color-limegreen":c===2?"marker-color-yellow":c===3?"marker-color-orangered":c===4?"marker-color-red":"marker-color-violet"}$(data).each(function(index,obj){var latlng=obj.latlng.toString().replace(/,/g,"").split(" ");garbageArray.push({latlng:obj.latlng,id:obj.id,amount:obj.amount,types:obj.types.join(", ")});var marker=new L.Marker(new L.LatLng(latlng[0],latlng[1]),{icon:garbageMarker,id:obj.id,amount:obj.amount,types:obj.types.join(", "),image_url:obj.image_url,latlng:obj.latlng,confirms:obj.confirms,todo:obj.todo,tags:obj.tag,note:obj.note,feature_type:"marker_garbage",size:obj.size,embed:obj.embed,created_by:obj.marked_by,created_at:obj.created_at,modified_at:obj.updated_at,cleaned:obj.cleaned,cleaned_by:obj.cleaned_by,cleaned_date:obj.cleaned_date});garbageLayerGroup.addLayer(marker);$(marker._icon).addClass(setClassColor(obj.amount));map.addLayer(garbageLayerGroup);marker.on("click",function(){featureClick(marker);var currentZindex=marker._zIndex;marker.setZIndexOffset(currentZindex+1e4)})})},error:function(data){void 0}})},200)}function loadCleaningMarkers(){setTimeout(function(){cleaningLayerGroup.clearLayers();var useToken=localStorage.getItem("token")||window.token;$.ajax({type:api.readCleaningWithinBounds.method,url:api.readCleaningWithinBounds.url(getCurrentBounds()),success:function(data){$(data).each(function(index,obj){var latlng=obj.latlng.toString().replace(/,/g,"").split(" ");cleaningArray.push({latlng:obj.latlng,id:obj.id,datetime:obj.datetime});var marker=new L.Marker(new L.LatLng(latlng[0],latlng[1]),{icon:cleaningMarker,id:obj.id,datetime:obj.datetime,latlng:obj.latlng,feature_type:"marker_cleaning",attends:obj.attends,recurrence:obj.recurrence,created_by:obj.created_by,created_at:obj.created_at,modified_at:obj.updated_at});cleaningLayerGroup.addLayer(marker);map.addLayer(cleaningLayerGroup);$(marker._icon).addClass("marker-color-blue");marker.on("click",function(){featureClick(marker)})})},error:function(data){void 0}})},300)}function loadAreas(){setTimeout(function(){areaLayerGroup.clearLayers();var useToken=localStorage.getItem("token")||window.token;$.ajax({type:api.readAreaWithinBounds.method,url:api.readAreaWithinBounds.url(getCurrentBounds()),headers:{Authorization:"Bearer "+useToken},success:function(data){$(data).each(function(index,obj){var latlngs=JSON.parse("["+obj.latlngs+"]");var polygonLayer=new L.Polygon(latlngs,{id:obj.id,title:obj.title,max_players:obj.max_players,curr_players:obj.curr_players,note:obj.note,tags:obj.tag,contact:obj.contact,feature_type:"polygon_area",shape:true,created_by:obj.created_by,created_at:obj.created_at,modified_at:obj.updated_at,color:"#33cccc",weight:5,opacity:.5,smoothFactor:3});areaLayerGroup.addLayer(polygonLayer);map.addLayer(areaLayerGroup);polygonLayer.on("click",function(){featureClick(polygonLayer)})})},error:function(data){void 0}})},400)}function loadLitters(){setTimeout(function(){litterLayerGroup.clearLayers();var useToken=localStorage.getItem("token")||window.token;$.ajax({type:api.readLitterWithinBounds.method,url:api.readLitterWithinBounds.url(getCurrentBounds()),headers:{Authorization:"Bearer "+useToken},success:function(data){$(data).each(function(index,obj){var latlngs=JSON.parse("["+obj.latlngs+"]");function setColor(c){return c===1?"#ccff66":c===2?"#ffff00":c===3?"#FF4500":c===4?"#ff1a1a":"#e60073"}var polylineLayer=L.polyline(latlngs,{id:obj.id,amount:obj.amount,types:obj.types.join(", "),image_url:obj.image_url,tags:obj.tag,shape:true,feature_type:"polyline_litter",created_by:obj.marked_by,cleaned:obj.cleaned,confirms:obj.confirms,cleaned_by:obj.cleaned_by,created_at:obj.created_at,modified_at:obj.updated_at,physical_length:obj.physical_length,weight:15,opacity:.5,smoothFactor:3,color:setColor(obj.amount)});litterLayerGroup.addLayer(polylineLayer);map.addLayer(litterLayerGroup);polylineLayer.on("click",function(){featureClick(polylineLayer)})})},error:function(data){void 0}})},500)}map.addOneTimeEventListener("zoomend",function(e){if(e.target.getZoom()<10){showAlert("Zoom in closer to create features","info",1200)}});L.Map.prototype.panToOffset=function(latlng,offset,options){var x=this.latLngToContainerPoint(latlng).x-offset[0],y=this.latLngToContainerPoint(latlng).y-offset[1],point=this.containerPointToLatLng([x,y]);return this.setView(point,this._zoom,{pan:options})};function getVerticalOffset(){var vOffset=[0,0];if(window.innerWidth>767){vOffset[1]=-$(window).height()/4+20}else{vOffset[1]=-$(window).height()/4}return vOffset}function getHorizontalOffset(){var hOffset=[0,0];hOffset[0]=-$(window).width()/5;return hOffset}var featuremenu=L.markerMenu({radius:100,size:[50,50],animate:true,duration:200,items:[{title:"Mark garbage",className:"fa fa-fw fa-2x fa-marker-menu fa-map-marker",click:function(){sidebar.show($("#create-garbage-dialog").show());setTimeout(function(){marker.closeMenu()},400)}},{title:"Create a cleaning event",className:"fa fa-fw fa-2x fa-marker-menu fa-calendar-o",click:function(){sidebar.show($("#create-cleaning-dialog").show());setTimeout(function(){marker.closeMenu()},400)}},{title:"Mark litter",className:"fa fa-fw fa-2x fa-marker-menu fa-ellipsis-h",click:function(){sidebar.show($("#create-litter-dialog").show());setTimeout(function(){marker.closeMenu()},400)}},{title:"Add an area",className:"fa fa-fw fa-2x fa-marker-menu fa-ellipsis-h",click:function(){sidebar.show($("#create-area-dialog").show());setTimeout(function(){marker.closeMenu()},400)}}]});function onMapClick(e){if(!sidebar.isVisible()&&!bottombar.isVisible()&&e.target.getZoom()>=10&&!$(".dropdown").hasClass("open")&&!$(".leaflet-control-layers").hasClass("leaflet-control-layers-expanded")&&!$(".leaflet-control-ocd-search").hasClass("leaflet-control-ocd-search-expanded")&&$(".leaflet-control-ocd-search-alternatives").hasClass("leaflet-control-ocd-search-alternatives-minimized")&&!$(".leaflet-compact-attribution-toggle").is(":checked")&&locationcontrol._active!==true){marker=L.marker(e.latlng,{icon:genericMarker,draggable:true});if($(window).width()<=567){if(!$(".leaflet-marker-menu").is(":visible")){marker.setMenu(featuremenu);map.addLayer(marker).panTo(marker._latlng);marker.openMenu()}}if($(window).width()>567){map.addLayer(marker);map.panToOffset(marker._latlng,getHorizontalOffset());$(".sidebar-content").hide();$("#sidebar").scrollTop=0;sidebar.show($("#create-marker-dialog").show())}$(".marker-latlng").val(marker._latlng.lat+", "+marker._latlng.lng);function setClassColor(c){return c===1?"marker-color-limegreen":c===2?"marker-color-yellow":c===3?"marker-color-orangered":c===4?"marker-color-red":"marker-color-violet"}$("input[type=radio]").on("change",function(){$(marker._icon).removeClass("marker-generic").addClass("marker-garbage");var selectedValue=parseInt($(this).attr("name"),10);$(marker._icon).removeClass(function(index,css){return(css.match(/(^|\s)marker-color-\S+/g)||[]).join(" ")}).addClass(setClassColor(selectedValue))});$("#event-date-time-picker").on("dp.change",function(e){var eventDateTime=e.date.format("YYYY-MM-DD HH:MM:SS");$("#date-time-value").val(eventDateTime);$(marker._icon).removeClass("marker-color-gray marker-generic").addClass("marker-cleaning marker-color-blue")});marker.on("dragend",function(event){var newPos=event.target.getLatLng();$(".marker-latlng").val(newPos.lat+", "+newPos.lng)});sidebar.on("hide",function(){if(marker){$(marker._icon).removeClass("marker-garbage");$(marker._icon).removeClass("marker-cleaning");$(marker._icon).removeClass(function(index,css){return(css.match(/(^|\s)marker-color-\S+/g)||[]).join(" ")}).addClass("marker-generic");$(marker._icon).addClass("marker-color-gray");if($(window).width()<=567){map.removeLayer(marker)}}});marker.on("click",onLocalMarkerClick)}else{if(e.target.getZoom()<10){showAlert("Zoom in closer to create features","info",1200)}locationcontrol.stop();bottombar.hide();sidebar.hide();$(".dropdown").removeClass("open");$(".leaflet-control-layers").removeClass("leaflet-control-layers-expanded");$(".leaflet-control-search").removeClass("leaflet-control-search-expanded");$(".leaflet-control-ocd-search").removeClass("leaflet-control-ocd-search-expanded");$(".leaflet-control-ocd-search-alternatives").addClass("leaflet-control-ocd-search-alternatives-minimized");$(".leaflet-control-ocd-search-icon").removeClass("fa-close").addClass("fa-search");$(".leaflet-compact-attribution-toggle").prop("checked",false)}}map.on("click",onMapClick);function onLocalMarkerClick(e){bottombar.hide();marker=this;$(".marker-latlng").val(marker._latlng.lat+", "+marker._latlng.lng);if($(window).width()<=567){map.addLayer(marker).panTo(marker._latlng);return}if($(window).width()>567){map.panToOffset(marker._latlng,getHorizontalOffset());$("#sidebar").scrollTop=0;$(".sidebar-content").hide();sidebar.show($("#create-marker-dialog").fadeIn());marker.on("dragend",function(event){var newPos=event.target.getLatLng();$(".marker-latlng").val(newPos.lat+", "+newPos.lng)})}}function featureClick(e){featureClick:{if(window.innerWidth<768){if($(".leaflet-marker-menu").is(":visible")){marker.closeMenu();break featureClick}}if(e.options){if(e.options.shape){setTimeout(function(){map.panToOffset(e.getCenter(),getVerticalOffset())},100)}else{var latlng=e.options.latlng.toString().replace(/,/g,"").split(" ");map.panToOffset([latlng[0],latlng[1]],getVerticalOffset())}pushDataToBottomPanel(e);if(sidebar.isVisible()){sidebar.hide()}}}}function editFeature(e){var userid=localStorage.getItem("userid");if(userid==e.marked_by){bottombar.hide();showAlert("The editing system isn't currently functional.","warning",3e3);if(e.feature_type==="marker_garbage"){sidebar.show($("#create-garbage-dialog").fadeIn())}if(e.feature_type==="marker_cleaning"){sidebar.show($("#create-cleaning-dialog").fadeIn())}if(e.feature_type==="polyline_litter"){sidebar.show($("#create-litter-dialog").fadeIn())}if(e.feature_type==="polygon_area"){sidebar.show($("#create-area-dialog").fadeIn())}}else{showAlert("You cannot edit feature created by others.","danger",3e3)}}function confirmGarbage(e){if(!localStorage.getItem("token")){showAlert("You need to login to do that.","info",2e3)}else{var callurl=null;if(e.feature_type==="marker_garbage"){callurl=api.confirmTrash.url(e.id)}else if(e.feature_type==="polyline_litter"){callurl=api.confirmLitter.url(e.id)}setTimeout(function(){var useToken=localStorage.getItem("token")||window.token;$.ajax({method:"PUT",url:callurl,headers:{Authorization:"Bearer"+useToken},success:function(response){var message=response.data.message;pushDataToBottomPanel(response.data.data);if(message.indexOf("litter")===0){loadLitters()}else{loadGarbageMarkers()}},error:function(err){showAlert("Something went wrong.","info",2e3)}})},100)}}function attendCleaning(e){if(!localStorage.getItem("token")){showAlert("You need to login to do that.","info",2e3)}else{setTimeout(function(){var useToken=localStorage.getItem("token")||window.token,id=e.id;$.ajax({method:"PUT",url:api.attendCleaning.url(id),headers:{Authorization:"Bearer"+useToken},success:function(response){pushDataToBottomPanel(response.data.data);loadCleaningMarkers()},error:function(err){showAlert("Something went wrong.","info",2e3)}})},100)}}function participateGame(e){if(!localStorage.getItem("token")){showAlert("You need to login to do that.","info",2e3)}setTimeout(function(){var useToken=localStorage.getItem("token")||window.token;$.ajax({method:api.joinCleaning.method,url:api.readCleaning.url(),headers:{Authorization:"Bearer"+useToken},data:{confirm:data},success:function(data){void 0},error:function(err){void 0}})},100)}function cleanedGarbage(e){if(!localStorage.getItem("token")){showAlert("You need to login to do that.","info",2e3)}else{setTimeout(function(){var useToken=localStorage.getItem("token")||window.token;$.ajax({method:api.confirmTrash.method,url:api.confirmTrash.url(),headers:{Authorization:"Bearer"+useToken},data:{clean:1},success:function(data){void 0},error:function(err){void 0}})},100)}}$(function(){$(".image-uploader").fileupload({headers:{Authorization:"Client-ID 6f050e213f46ba9"},type:"POST",url:"https://api.imgur.com/3/upload",dataType:"json",paramName:"image",progressall:function(e,data){var progress=parseInt(data.loaded/data.total*100,10);$(".progress").removeClass("hidden");$(".progress-bar").css("width",progress+"%")},fail:function(err){void 0;$(".progress").addClass("hidden").delay(400)},error:function(err){void 0;$(".progress").addClass("hidden").delay(400)},done:function(e,data){void 0;$(e.target).parent().next().val(data.result.data.link);$(".progress").addClass("hidden").delay(200)}});$(".btn-image-uploader").on("click",function(){if(localStorage.getItem("token")){$(this).next().trigger("click")}else{showAlert("You need to be be authenticated to do that.","warning",2e3);return}})});window.token="eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOjYsImlzcyI6Imh0dHA6XC9cL2FwaS5nYXJiYWdlcGxhLm5ldFwvYXBpXC9hdXRoZW50aWNhdGUiLCJpYXQiOiIxNDQ2OTAxNTcxIiwiZXhwIjoiMTQ0NjkwNTE3MSIsIm5iZiI6IjE0NDY5MDE1NzEiLCJqdGkiOiJhMzljOTg1ZDZmNWNjNmU4MGNlMmQzOWZjODg5NWM1YSJ9.R28VF7VI1S3-PpvaG6cjpyxpygvQCB0JXF5oQ27TxCw";$(function(){$(".form-garbage").on("submit",function(e){e.preventDefault();var that=this,garbageType=[],tags=[],garbageTodo,garbageAmount,latlng,image_url,garbageSize=[],garbageEmbed=[],note;$(this).find(".selectpicker.garbage-type-select option:selected").each(function(index,value){garbageType.push($(value).val())});garbageTodo=$(this).find(".selectpicker.garbage-todo-select option:selected").val();$(this).find(".selectpicker.garbage-size-select option:selected").each(function(index,value){garbageSize.push($(value).val())||""});$(this).find(".selectpicker.garbage-embed-select option:selected").each(function(index,value){garbageEmbed.push($(value).val())||""});garbageAmount=$(".btn-group-amount").find(".active > input").attr("name")||"3";note=$(this).find(".garbage-note").val()||"";image_url=$(this).find(".garbage-image-hidden-value").val()||"";tags=$(this).find(".garbage-tags").tagsinput("items")||"";latlng=$(this).find(".garbage-latlng").val();setTimeout(function(){var useToken=localStorage.getItem("token")||window.token;$.ajax({method:api.createTrash.method,url:api.createTrash.url(),headers:{Authorization:"Bearer "+useToken},data:{latlng:latlng,amount:garbageAmount,types:garbageType.join(),todo:garbageTodo,image_url:image_url,tag:tags.join(),sizes:garbageSize.join(),embed:garbageEmbed.join(),note:note},success:function(data){void 0;showAlert("Marker saved successfully!","success",1500);sidebar.hide("slow");map.removeLayer(marker);loadGarbageMarkers()},error:function(response){showErrorType(response);sidebar.hide();map.removeLayer(marker)}})},100)})});$(function(){$(".form-cleaning").on("submit",function(e){e.preventDefault();var that=this,tags=[],eventRecurrence,dateTime,note,latlng;dateTime=$("#date-time-value").val();tags=$(this).find(".cleaning-tags").tagsinput("items")||"";note=$(this).find(".cleaning-note").val()||"";latlng=$(this).find(".cleaning-latlng").val();eventRecurrence=$(this).find(".selectpicker.cleaning-recurrent-select option:selected").val();setTimeout(function(){var useToken=localStorage.getItem("token")||window.token;$.ajax({method:api.createCleaning.method,url:api.createCleaning.url(),headers:{Authorization:"Bearer "+useToken},dataType:"json",data:{latlng:latlng,datetime:dateTime,note:note,recurrence:eventRecurrence,tag:tags.join()},success:function(data){showAlert("Cleaning event saved successfully!","success",2e3);sidebar.hide("slow");loadCleaningMarkers();map.removeLayer(marker)},error:function(response){showErrorType(response);sidebar.hide();map.removeLayer(marker)}})},100)})});$(function(){$(".form-litter").on("submit",function(e){$(".btn-draw").removeClass("disabled");e.preventDefault();var that=this,litterType=[],tags=[],litterAmount,latlngs,image_url,length,note,amount_quantitative;latlngs=$(this).find(".litter-latlngs").val();$(this).find(".selectpicker.litter-type-select option:selected").each(function(index,value){litterType.push($(value).val())});tags=$(this).find(".litter-tags").tagsinput("items")||"";amount_quantitative=$(this).find(".litter-amount-quantitative").val()||"";litterAmount=$(".btn-group-amount-litter").find(".active > input").attr("name")||"3";physical_length=$(this).find(".litter-path-length").val()||"";image_url=$(this).find(".litter-image-hidden-value").val()||"";note=$("input[class=litter-note]").val()||"";setTimeout(function(){var useToken=localStorage.getItem("token")||window.token;$.ajax({method:api.createLitter.method,url:api.createLitter.url(),headers:{Authorization:"Bearer "+useToken},dataType:"json",data:{latlngs:latlngs.toString(),amount:litterAmount,types:litterType.join(),image_url:image_url,tag:tags.join()},success:function(data){void 0;showAlert("Litter saved successfully!","success",1500);sidebar.hide("slow");loadLitters()},error:function(response){showErrorType(response);sidebar.hide();map.removeLayer(polylineLayer)}})},200)})});$(function(){$(".form-area").on("submit",function(e){$(".btn-draw").removeClass("disabled");e.preventDefault();var that=this,tags=[],latlngs,note,secret,max_players,title,contact,game;game=$(".tile-game-check input:checked").length||0;void 0;latlngs=$(this).find(".area-latlngs").val();title=$(this).find(".area-title").val();note=$(this).find(".area-note").val()||"";secret=$(this).find(".area-secret").val()||"";contact=$(this).find(".area-contact").val()||"";players=$(this).find(".area-players").val()||"";tags=$(this).find(".area-tags").tagsinput("items")||"";function randomString(len){var randomStringValue=" ",charset="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";for(var i=0;i<len;i++){randomStringValue+=charset.charAt(Math.floor(Math.random()*charset.length))}return randomStringValue}if(!title){title=randomString(12);void 0}setTimeout(function(){var useToken=localStorage.getItem("token")||window.token;$.ajax({method:api.createArea.method,url:api.createArea.url(),headers:{Authorization:"Bearer "+useToken},dataType:"json",data:{latlngs:latlngs,note:note,contact:contact,secret:secret,title:title,tag:tags.join(),game:game},success:function(data){void 0;showAlert("Area saved successfully!","success",1500);sidebar.hide("slow");loadAreas()},error:function(response){showErrorType(response);sidebar.hide();map.removeLayer(polygoneLayer)}})},200)})});$(document).ready(function(){$(".selectpicker").selectpicker({style:"btn-lg btn-default text-center",size:6});$(function(){$("#event-date-time-picker").datetimepicker({minDate:new Date(2016,4,1),showClose:true,ignoreReadonly:true,focusOnShow:false,toolbarPlacement:"top"})});$(".feature-tags").tagsinput({maxTags:3,confirmKeys:[32,39],maxChars:16,trimValue:true});$(".form-feature").bind("keypress",function(e){if(e.keyCode===13){$(".btn-save").attr("type");e.preventDefault()}})});$("#modal-list-garbage").on("click",function(){$("body").append('<div id="modal-data" class="modal" role="dialog"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close pull-right" data-dismiss="modal"><span class="fa fa-fw fa-times"></span></button><h4 class="modal-title">View and download data from garbagepla.net</h4></div><div class="modal-body"><table id="modal-garbage-table" class="table-striped table-condensed"><thead><tr><th>Feature id</th><th>Coordinates</th><th>Amount</th><th>Garbage types</th></tr></thead><tbody id="modal-garbage-table-body"></tbody></table></div><div class="modal-footer"><a class="disabled pull-left" href="#">Get the full data</a><form><button type="button" data-dismiss="modal" class="btn btn-danger pull-right ">Close</button><button id="modal-data-load-more" type="button" class="btn btn-default pull-right ">Zoom out and load more</button><a id="modal-garbage-download" href="" target="_blank" data-download="data.txt" type="button" class="btn btn-default pull-right">Download</a></form></div></div></div></div>');document.getElementById("modal-garbage-table-body").innerHTML=tmpl("tmpl-modal-garbage",garbageArray);$("#modal-data").modal("show");$("#modal-garbage-table").DataTable();$("#modal-data-load-more").on("click",function(){map.setZoom(map.getZoom()-1);$(".modal-data-row").empty();document.getElementById("modal-garbage-table-body").innerHTML=tmpl("tmpl-modal-garbage",garbageArray)});$("#modal-garbage-download").on("click",function(){var stringdata="text/json;charset=utf-8,"+JSON.stringify(garbageArray);this.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(stringdata))})});$("#modal-list-cleaning").on("click",function(){$("body").append('<div id="modal-calendar" class="modal" role="dialog"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close pull-right" data-dismiss="modal"><span class="fa fa-fw fa-times"></span></button><h4 class="modal-title">Cleaning events calendar</h4></div><div class="modal-body"><table id="modal-calendar-table" class="table-striped table-condensed"><thead><tr><th>Event id</th><th>Date</th><th>Coordinates</th><th>Address</th></tr></thead><tbody id="modal-calendar-table-body"></tbody></table></div><div class="modal-footer"><form><button type="button" data-dismiss="modal" class="btn btn-danger pull-right ">Close</button><button id="modal-calendar-load-more" type="button" class="btn btn-default pull-right ">Zoom out and load more</button><a id="modal-calendar-download" href="" target="_blank" data-download="data.txt" type="button" class="btn btn-default pull-right">Download</a></form></div></div></div></div>');document.getElementById("modal-calendar-table-body").innerHTML=tmpl("tmpl-modal-cleaning",cleaningArray);$("#modal-calendar").modal("show");$("#modal-calendar-table").DataTable();$("#modal-calendar-load-more").on("click",function(){map.setZoom(map.getZoom()-1);$(".modal-calendar-row").empty();document.getElementById("modal-calendar-table-body").innerHTML=tmpl("tmpl-modal-cleaning",cleaningArray)});$("#modal-calendar-download").on("click",function(){var stringdata="text/json;charset=utf-8,"+JSON.stringify(cleaningArray);this.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(stringdata))})});var devTour=new Tour({name:"dev-tour",template:"<div class='popover tour'><div class='arrow'></div><div class='popover-content'></div><div class='popover-navigation'><a class='btn-tour' data-role='end'><i class='fa fa-fw fa-times close'></i></a></div></div>",steps:[{content:"Note that this platform is currently under active development but all the basic functions are available and can be used to save markers and images.",duration:16e3,orphan:true}]});var mobileTour=new Tour({name:"mobile-tour",template:"<div class='popover tour'><div class='arrow'></div><div class='popover-content'></div><div class='popover-navigation'><a class='btn-tour' data-role='end'><i class='fa fa-fw fa-times close'></i></a></div></div>",steps:[{element:".swipe-area-right",placement:"left",content:"Access the main menu by swiping from the right border of the screen.",duration:4e3}]});window.startTour=function(){if($(window).width()>=768){if(!localStorage.getItem("token")){devTour.init();devTour.start(true)}}if($(window).width()<768){mobileTour.init();mobileTour.start(true)}};$(document).ready(function(){setTimeout(startTour,1e3)});var editableLayerGroup=new L.FeatureGroup;var drawControl=new L.Control.Draw({position:"topright",draw:{circle:false,rectangle:false,marker:false},edit:{featureGroup:editableLayerGroup,remove:false}});map.addControl(drawControl);map.on("draw:drawstart",function(e){map.removeLayer(marker);var type=e.layerType,layer=e.layer;$(".btn-draw").addClass("disabled")});map.on("draw:editstart",function(e){map.off("click",onMapClick);$(".btn-draw").addClass("disabled")});map.on("draw:editstop",function(e){$(".leaflet-draw-edit-edit").removeClass("visible");$(".leaflet-draw-edit-remove").removeClass("visible")});map.on("draw:deletestart",function(e){map.off("click",onMapClick);$(".btn-draw").addClass("disabled")});map.on("draw:deletestop",function(e){map.on("click",onMapClick);$(".leaflet-draw-edit-edit").removeClass("visible");$(".leaflet-draw-edit-remove").removeClass("visible")});map.on("draw:drawstop",function(){map.off("click",onMapClick);map.on("click",onMapClick)});map.on("draw:created",function(e){var latlngs=e.layer.getLatLngs().toString().replace(/\(/g,"[").replace(/\)/g,"]").replace(/LatLng/g,"");void 0;if(e.layerType==="polyline"){if($(window).width()<=567){sidebar.show($("#create-litter-dialog").show())}function setClassColor(c){return c===1?"#ccff66":c===2?"#ffff00":c===3?"#FF4500":c===4?"#ff1a1a":"#e60073"}polylineLayer=e.layer;map.fitBounds(e.layer.getBounds(),{paddingBottomRight:[300,0]});$(".litter-latlngs").val(latlngs);$("input[type=radio]").on("change",function(){var selectedValue=parseInt($(this).attr("name"),10);e.layer.setStyle({color:setClassColor(selectedValue)})});editableLayerGroup.addLayer(e.layer);map.addLayer(editableLayerGroup);$(".btn-cancel").on("click",function(){$(".leaflet-draw-edit-edit").removeClass("visible");$(".leaflet-draw-edit-remove").removeClass("visible");map.removeLayer(e.layer)});sidebar.on("hide",function(){map.removeLayer(e.layer)})}if(e.layerType==="polygon"){if($(window).width()<=567){sidebar.show($("#create-area-dialog").show())}polygonLayer=e.layer;map.fitBounds(e.layer.getBounds(),{paddingBottomRight:[300,0]});$(".form-area .area-latlngs").val(latlngs);editableLayerGroup.addLayer(e.layer);map.addLayer(editableLayerGroup);$(".btn-cancel").on("click",function(){$(".leaflet-draw-edit-edit").removeClass("visible");$(".leaflet-draw-edit-remove").removeClass("visible");map.removeLayer(e.layer)});sidebar.on("hide",function(){map.removeLayer(e.layer)})}map.on("click",onMapClick)});map.on("draw:edited",function(e){var layers=e.layers;layers.eachLayer(function(layer){var type=e.layerType,currentlayer=e.layer;if(type==="polyline"){return"polyline"}if(type==="polygon"){return"polygon"}});map.on("click",onMapClick)});$(".btn-draw-polyline").on("click",function(){map.off("click",onMapClick);$(".leaflet-draw-edit-remove").addClass("visible");new L.Draw.Polyline(map,{allowIntersection:false,drawError:{color:"#cc0000",timeout:2e3},metric:true,clickable:true,shapeOptions:{color:"#A9A9A9",weight:10,opacity:.5}}).enable();if($(window).width()<=567){sidebar.hide();showAlert("Drawing on mobile is still in development, expect issues.","warning",3500)}});$(".btn-draw-polygon").on("click",function(){map.off("click",onMapClick);$(".leaflet-draw-edit-remove").addClass("visible");new L.Draw.Polygon(map,{shapeOptions:{color:"#33cccc",weight:5,opacity:.5},showArea:true,metric:true,clickable:true,allowIntersection:false,drawError:{color:"#cc0000",timeout:2e3}}).enable();if($(window).width()<=567){sidebar.hide();showAlert("Drawing on mobile is still in development, expect issues.","warning",3500)}});function shareThisFeature(obj){var featuredata=obj,encoded_url=encodeURIComponent(window.location),feature_image_url,feature_note,feature_tags;featuredata.image_url?feature_image_url=featuredata.image_url:feature_image_url="";feature_image_url_encoded=encodeURIComponent(feature_image_url);featuredata.note?feature_note=featuredata.note:feature_note="";feature_note_encoded=encodeURIComponent(feature_note);featuredata.tags?feature_tags=featuredata.tags:feature_tags="";feature_tags_encoded=encodeURIComponent(feature_tags);templatedata.social.network[0].targeturl="https://www.facebook.com/dialog/feed?app_id=109950712685962&display=page&href="+encoded_url+"&description="+feature_note_encoded+"&link="+encoded_url+"&picture="+feature_image_url_encoded+"&name=Garbagepla.net&redirect_uri=https://www.garbagepla.net";templatedata.social.network[1].targeturl="https://twitter.com/intent/tweet?text=Shared%20from%20www.garbagepla.net%20"+feature_note_encoded+"%20"+feature_tags_encoded+"%20"+encoded_url;templatedata.social.network[2].targeturl="https://plus.google.com/share?url="+encoded_url;templatedata.social.network[3].targeturl="http://reddit.com/submit?url="+encoded_url+"&title=Shared%20from%20www.garbagepla.net";templatedata.social.network[4].targeturl="http://www.tumblr.com/share/link?url="+encoded_url+"&amp;name="+"&amp;description="+feature_note_encoded;templatedata.social.network[5].targeturl="whatsapp://send?text=Shared%20from%20www.garbagepla.net";templatedata.social.network[6].targeturl="https://vk.com/share.php?url="+encoded_url;templatedata.social.network[7].targeturl="http://share.renren.com/share/buttonshare.do?link="+encoded_url+"&title=Share from Garbagepla.net"}