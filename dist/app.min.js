var api={server:"http://gp.local:8080/api",createUser:{method:"POST",url:function(){return api.server+"/register"}},readUser:{method:"GET",url:function(){return api.createLogin.url()+"/user"}},createLogin:{method:"POST",url:function(){return api.server+"/authenticate"}},createSoftAccount:{method:"POST",url:function(){return api.server+"/glome/create"}},readSoftAccount:{method:"GET",url:function(id){return api.server+"/glome/show/"+id}},createTrash:{method:"POST",url:function(id){return api.readTrash.url()}},readTrash:{method:"GET",url:function(){return api.server+"/trashes"}},editTrash:{method:"PUT",url:function(){return api.readTrash.url()}},confirmTrash:{method:"PUT",url:function(){return api.readTrash.url()}},deleteTrash:{method:"DELETE",url:function(id){return api.readTrash.url()+"/"+id}},readTrashWithinBounds:{method:"GET",url:function(allBounds){return api.readTrash.url()+"/withinbounds?bounds="+currentViewBounds}},createCleaning:{method:"POST",url:function(id){return api.readCleaning.url()}},readCleaning:{method:"GET",url:function(){return api.server+"/cleanings"}},editCleaning:{method:"PUT",url:function(){return api.readCleaning.url()+"/"+id}},deleteCleaning:{method:"DELETE",url:function(id){return api.readCleaning.url()+"/"+id}},readCleaningWithinBounds:{method:"GET",url:function(allBounds){return api.readCleaning.url()+"/withinbounds?bounds="+currentViewBounds}},readLitterWithinBounds:{method:"GET",url:function(allBounds){return api.readLitter.url()+"/withinbounds?bounds="+currentViewBounds}},createLitter:{method:"POST",url:function(){return api.readLitter.url()}},editLitter:{method:"PUT",url:function(){return api.readLitter.url()+"/"+id}},readLitter:{method:"GET",url:function(){return api.server+"/litter"}},deleteLitter:{method:"DELETE",url:function(id){return api.readLitter.url()+"/"+id}},readAreaWithinBounds:{method:"GET",url:function(allBounds){return api.readArea.url()+"/withinbounds?bounds="+currentViewBounds}},createArea:{method:"POST",url:function(){return api.readArea.url()}},editArea:{method:"PUT",url:function(){return api.readArea.url()+"/"+id}},readArea:{method:"GET",url:function(){return api.server+"/area"}},deleteArea:{method:"DELETE",url:function(id){return api.readArea.url()+"/"+id}}};var map=L.map("map",{zoomControl:false,attributionControl:false});var hash=new L.Hash(map);L.tileLayer("https://api.tiles.mapbox.com/v4/adriennn.9da931dd/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiYWRyaWVubm4iLCJhIjoiNWQ5ZTEwYzE0MTY5ZjcxYjIyNmExZDA0MGE2MzI2YWEifQ.WGCZQzbVhF87_Z_Yo1aMIQ",{maxZoom:20}).addTo(map);map.locate({setView:true,maxZoom:15});function onLocationError(e){showAlert("Couldn't find your position.","warning",4e3)}map.on("locationerror",onLocationError);var sidebar=L.control.sidebar("sidebar",{position:"right",closebutton:"true"});map.addControl(sidebar);var bottombar=L.control.sidebar("bottombar",{position:"bottom",closebutton:"true"});map.addControl(bottombar);var garbageLayerGroup=new L.LayerGroup,areaLayerGroup=new L.FeatureGroup,pathLayerGroup=new L.FeatureGroup,cleaningLayerGroup=new L.LayerGroup;map.addLayer(garbageLayerGroup,cleaningLayerGroup,pathLayerGroup,areaLayerGroup);var overlayGroups={"Garbage markers":garbageLayerGroup,"Cleaning events":cleaningLayerGroup,"Littered coasts and roads":pathLayerGroup,"Tiles and areas":areaLayerGroup};map.addControl(L.control.zoom({position:"topleft"}));L.control.layers(overlayGroups).setPosition("topleft").addTo(map);$(".leaflet-control-layers-toggle").append("<span class='fa fa-2x fa-eye fa-icon-black fa-icon-centered'></span>");new L.control.scale({metric:true,imperial:false}).addTo(map);map.doubleClickZoom.disable();map.on("zoomend",function(e){mapZoom=e.target.getZoom();if(mapZoom<10){showAlert("Zoom in closer to create markers","info",1200)}});var genericMarker=L.divIcon({className:"map-marker marker-color-gray marker-generic",iconSize:[30,30],html:'<i class="fa fa-fw"></i>'});var garbageMarker=L.divIcon({className:"map-marker marker-garbage",iconSize:[30,30],html:'<i class="fa fa-fw"></i>'});var cleaningMarker=L.divIcon({className:"map-marker marker-cleaning",iconSize:[30,30],html:'<i class="fa fa-fw"></i>'});function onGarbageMarkerClick(e){void 0;void 0;var that=this,markerTypes=e.options.Types,markerAmount=e.options.Amount,markerRawImage=e.options.ImageUrl,markerId=e.options.Id,markerCreatedBy=e.options.marked_by,markerNote=e.options.note,markerTags=e.options.tag,markerTodo=e.options.todo,markerConfirm=e.options.confirm,markertarget="http://garbagepla.net/#15/"+e.options.Lat+"/"+e.options.Lng+"string";map.panToOffset([e.options.Lat,e.options.Lng],_getVerticalOffset());sidebar.hide();clearBottomPanelContent();if(!markerRawImage){$("#feature-info").find(".feature-image").attr("src","http://placehold.it/160x120");$("#feature-info").find(".feature-image-link").attr("href","")}if(markerRawImage){String.prototype.insert=function(index,string){if(index>0){return this.substring(0,index)+string+this.substring(index,this.length)}else{return string+this}};markerImage=markerRawImage.insert(26,"t");$("#feature-info").find(".feature-image").attr("src",markerImage);$("#feature-info").find(".feature-image-link").attr("href",markerRawImage)}$("#feature-info").find(".feature-info-garbage-type").html(markerTypes.join(", "));$("#feature-info-created-by").html(markerCreatedBy);$("#feature-info").find(".btn-share").each(function(){$(this).attr("data-url",markertarget)});bottombar.show();$("#feature-info").fadeIn();$("#feature-info").find(".btn-delete").click(function(e){void 0;e.preventDefault();var useToken=localStorage.getItem("token")||window.token;$.ajax({type:api.deleteTrash.method,url:api.deleteTrash.url(markerId),headers:{Authorization:"Bearer "+useToken},success:function(response){bottombar.hide();loadGarbageMarkers();showAlert("Marker deleted successfully!","success",1500)},error:function(response){showAlert("Failed to remove this marker.","warning",2e3)}})});$("#feature-info").find(".btn-edit").click(function(e){e.preventDefault();void 0;editFeature(e)});switch(markerAmount){case 0:$("#feature-info").find(".feature-info-garbage-amount").html("Are you sure about that?");break;case 1:$("#feature-info").find(".feature-info-garbage-amount").html("You are seeing ghosts");break;case 2:$("#feature-info").find(".feature-info-garbage-amount").html("Here and there");break;case 3:$("#feature-info").find(".feature-info-garbage-amount").html("Quite some");break;case 4:$("#feature-info").find(".feature-info-garbage-amount").html("Already too much");break;case 5:$("#feature-info").find(".feature-info-garbage-amount").html("What happened here?");break;case 6:$("#feature-info").find(".feature-info-garbage-amount").html("This is getting out of hand");break;case 7:$("#feature-info").find(".feature-info-garbage-amount").html("Dude...");break;case 8:$("#feature-info").find(".feature-info-garbage-amount").html("What the what?");break;case 9:$("#feature-info").find(".feature-info-garbage-amount").html("Cant touch this");break;case 10:$("#feature-info").find(".feature-info-garbage-amount").html("Oh my God Becky, look at...");break;default:$("#feature-info").find(".feature-info-garbage-amount").html("Undefined");break}}function onCleaningMarkerClick(e){void 0;void 0;var that=this,markerTypes=e.options.Types,markerDate=e.options.Date,markerId=e.options.Id,markerCreatedBy=e.options.marked_by;map.panToOffset([e.options.Lat,e.options.Lng],_getVerticalOffset());sidebar.hide();clearBottomPanelContent();$("#cleaning-info-created-by").html(markerCreatedBy);bottombar.show();$("#cleaning-info").fadeIn();$("#cleaning-info").find(".btn-delete").click(function(e){void 0;e.preventDefault();var useToken=localStorage.getItem("token")||window.token;$.ajax({type:api.deleteCleaning.method,url:api.deleteCleaning.url(markerId),headers:{Authorization:"Bearer "+useToken},success:function(response){bottombar.hide();loadCleaningMarkers();showAlert("Marker deleted successfully!","success",1500)},error:function(response){showAlert("Failed to remove this marker.","warning",2e3)}})});$("#feature-info").find(".btn-edit").click(function(e,obj){void 0;editFeature(obj);e.preventDefault()})}function onAreaClick(e){void 0;void 0;void 0;var that=this,areaLatLngs=e.layer.options.LatLngs,areaId=e.layer.options.Id,areatags=e.layer.options.Tags,areacontact=e.layer.options.Contact,areanote=e.layer.options.Note,areatitle=e.layer.options.Title,areaplayers=e.layer.options.Players,areaCreatedBy=e.options.marked_by;sidebar.hide();map.panToOffset(e.getCenter(),_getVerticalOffset());map.fitBounds(e.layer.getBounds());clearBottomPanelContent();bottombar.show();$("#feature-info").fadeIn();$("#feature-info").find(".btn-delete").click(function(e){e.preventDefault();var useToken=localStorage.getItem("token")||window.token;$.ajax({type:api.deleteArea.method,url:api.deleteArea.url(areaId),headers:{Authorization:"Bearer "+useToken},success:function(response){bottombar.hide();loadAreas();showAlert("Area deleted successfully.","success",1500)},error:function(response){showAlert("Failed to delete this area.","warning",2e3)}})});$("#feature-info").find(".btn-edit").click(function(e){void 0;e.preventDefault();editFeature(e.obj,"polygon")})}function onLitterClick(e){void 0;void 0;void 0;var that=this,litterType=e.layer.options.Type,litterAmount=e.layer.options.Amount,litterRawImage=e.layer.options.ImageUrl,litterLatLngs=e.layer.options.LatLngs,litterId=e.layer.options.Id,litterTags=e.layer.options.Tags,litterNote=e.layer.options.Note,litterLength=e.layer.options.Length,litterConfirm=e.layer.options.Confirm,litterCreatedBy=e.options.marked_by;sidebar.hide();map.panToOffset(e.getCenter(),_getVerticalOffset());clearBottomPanelContent();map.fitBounds(e.layer.getBounds(),{paddingBottomRight:[0,200]});if(!litterRawImage){$("#feature-info").find(".feature-image").attr("src","http://placehold.it/160x120");$("#feature-info").find(".feature-image-link").attr("href","")}if(litterRawImage){String.prototype.insert=function(index,string){if(index>0){return this.substring(0,index)+string+this.substring(index,this.length)}else{return string+this}};litterImage=litterRawImage.insert(26,"t");$("#feature-info").find(".feature-image").attr("src",litterImage);$("#feature-info").find(".feature-image-link").attr("href",litterRawImage)}bottombar.show();$("#feature-info").fadeIn();$("#feature-info").find(".btn-delete").click(function(e){e.preventDefault();var useToken=localStorage.getItem("token")||window.token;$.ajax({type:api.deleteShape.method,url:api.deleteShape.url(litterId),headers:{Authorization:"Bearer "+useToken},success:function(response){bottombar.hide();loadRemoteLitter();showAlert("Litter line deleted successfully.","success",1500)},error:function(response){showAlert("Failed to delete this litter line.","warning",2e3)}})});$("#feature-info").find(".btn-edit").click(function(e){void 0;e.preventDefault();editFeature(e.obj,"litter")});switch(litterAmount){case 0:$("#feature-info").find(".feature-info-garbage-amount").html("Are you sure about that?");break;case 1:$("#feature-info").find(".feature-info-garbage-amount").html("You are seeing ghosts");break;case 2:$("#feature-info").find(".feature-info-garbage-amount").html("Here and there");break;case 3:$("#feature-info").find(".feature-info-garbage-amount").html("Quite some");break;case 4:$("#feature-info").find(".feature-info-garbage-amount").html("Already too much");break;case 5:$("#feature-info").find(".feature-info-garbage-amount").html("What happened here?");break;case 6:$("#feature-info").find(".feature-info-garbage-amount").html("This is getting out of hand");break;case 7:$("#feature-info").find(".feature-info-garbage-amount").html("Dude...");break;case 8:$("#feature-info").find(".feature-info-garbage-amount").html("What the what?");break;case 9:$("#feature-info").find(".feature-info-garbage-amount").html("Cant touch this");break;case 10:$("#feature-info").find(".feature-info-garbage-amount").html("Oh my God Becky, lok at...");break;default:$("#feature-info").find(".feature-info-garbage-amount").html("Undefined");break}}function loadGarbageMarkers(){void 0;garbageLayerGroup.clearLayers();$.ajax({type:api.readTrashWithinBounds.method,url:api.readTrashWithinBounds.url(currentViewBounds),success:function(data){$(data).each(function(index,obj){var marker=new L.Marker(new L.LatLng(obj.lat,obj.lng),{icon:garbageMarker,Id:obj.id,Amount:obj.amount,Types:obj.types,ImageUrl:obj.image_url,Lat:obj.lat,Lng:obj.lng,Confirm:obj.confirm,Todo:obj.todo,Tags:obj.tag,Note:obj.note,FeatureType:obj.featuretype});garbageLayerGroup.addLayer(marker);map.addLayer(garbageLayerGroup);marker.on("click",function(){onGarbageMarkerClick(marker)});switch(obj.amount){case 0:$(marker._icon).addClass("marker-color-darkgreen");break;case 1:$(marker._icon).addClass("marker-color-green");break;case 2:$(marker._icon).addClass("marker-color-limegreen");break;case 3:$(marker._icon).addClass("marker-color-yellow");break;case 4:$(marker._icon).addClass("marker-color-gold");break;case 5:$(marker._icon).addClass("marker-color-orange");break;case 6:$(marker._icon).addClass("marker-color-orangered");break;case 7:$(marker._icon).addClass("marker-color-red");break;case 8:$(marker._icon).addClass("marker-color-darkred");break;case 9:$(marker._icon).addClass("marker-color-purple");break;case 10:$(marker._icon).addClass("marker-color-black");break;default:$(marker._icon).addClass("marker-color-unknown");break}})},error:function(data){void 0}});var useToken=localStorage.getItem("token")||window.token}function loadCleaningMarkers(){void 0;cleaningLayerGroup.clearLayers();$.ajax({type:api.readCleaningWithinBounds.method,url:api.readCleaningWithinBounds.url(currentViewBounds),success:function(data){$(data).each(function(index,obj){void 0;var marker=new L.Marker(new L.LatLng(obj.lat,obj.lng),{icon:cleaningMarker,Id:obj.id,Date:obj.date,Lat:obj.lat,Lng:obj.lng,FeatureType:obj.featuretype,Paticipants:obj.participants,Recurrence:obj.recurrence});cleaningLayerGroup.addLayer(marker);map.addLayer(cleaningLayerGroup);marker.on("click",function(){onCleaningMarkerClick(marker)})})},error:function(data){void 0}});var useToken=localStorage.getItem("token")||window.token}function loadAreas(){void 0;areaLayerGroup.clearLayers();var useToken=localStorage.getItem("token")||window.token;$.ajax({type:api.readAreaWithinBounds.method,url:api.readAreaWithinBounds.url(currentViewBounds),headers:{Authorization:"Bearer "+useToken},success:function(data){void 0;$(data).each(function(index,obj){void 0;var polygonLayer=new L.Polygon(obj.latlngs,{Id:obj.id,Title:obj.title,Players:obj.players,Note:obj.note,Tags:obj.tag,Contact:obj.contact,FeatureType:obj.featuretype});areaLayerGroup.addLayer(polygonLayer);map.addLayer(areaLayerGroup);polygonLayer.on("click",function(){onAreaClick(polygonLayer)})})},error:function(data){void 0}})}function loadLitters(){void 0;pathLayerGroup.clearLayers();var useToken=localStorage.getItem("token")||window.token;$.ajax({type:api.readLitterWithinBounds.method,url:api.readLitterWithinBounds.url(currentViewBounds),headers:{Authorization:"Bearer "+useToken},success:function(data){void 0;$(data).each(function(index,obj){void 0;var polylineLayer=new L.Polyline(obj.latlngs,{Id:obj.id,Amount:obj.amount,Types:obj.types,ImageUrl:obj.image_url,Tags:obj.tag,FeatureType:obj.featuretype});switch(obj.amount){case 1:polylineLayer.setStyle({color:"green"});break;case 2:polylineLayer.setStyle({color:"limegreen"});break;case 3:polylineLayer.setStyle({color:"yellow"});break;case 4:polylineLayer.setStyle({color:"gold"});break;case 5:polylineLayer.setStyle({color:"orange"});break;case 6:polylineLayer.setStyle({color:"orangered"});break;case 7:polylineLayer.setStyle({color:"red"});break;case 8:polylineLayer.setStyle({color:"darkred"});break;case 9:polylineLayer.setStyle({color:"purple"});break;case 10:polylineLayer.setStyle({color:"black"});break;default:polylineLayer.resetStyle();break}pathLayerGroup.addLayer(polylineLayer);map.addLayer(pathLayerGroup);polylineLayer.on("click",function(){onLitterClick(polylineLayer)})})},error:function(data){void 0}})}map.on("moveend",function(e){var mapZoom,bounds=map.getBounds();currentViewBounds=bounds._northEast.lat+", "+bounds._northEast.lng+", "+bounds._southWest.lat+", "+bounds._southWest.lng;if(mapZoom>=10){void 0;loadGarbageMarkers();loadCleaningMarkers()}if(mapZoom>=8&&mapZoom<=17){loadLitters()}if(mapZoom>=7&&mapZoom<=15){loadAreas()}});if(L.Browser.mobile){showAlert("Drawing tools are not available on mobile.","info",4e3)}function switchSession(sessionStatus){var classicSessionType=localStorage.getItem("classic");if(sessionStatus==="logout"){$("#session-status a").text("Login").attr("href","#user-login-dialog");$("#session-status a").attr("id","");$("#session-status a").addClass("dropdown-link");$("#user-info-lnk").remove();$("#user-tools").dropdown();$(".user-email, .user-glome-key").removeClass("hidden");$(".glome-lnk, .btn-glome-mobile").removeClass("hidden")}if(sessionStatus==="login"){$("#session-status a").text("Logout").attr("href","#");$("#session-status a").attr("id","btn-logout");$("#session-status a").removeClass("dropdown-link");$("#session-status").on("click","#btn-logout",function(){switchSession("logout");logout()});$("#user-tools").prepend('<li id="user-info-lnk"><a class="dropdown-link" href="#account-info">User info</a></li>');$("#user-info-lnk a").on("click",function(e){e.preventDefault();$("#sidebar").scrollTop=0;$(this.hash).fadeIn().siblings().hide();sidebar.show()});$("#user-tools").dropdown();$(".glome-lnk, .btn-glome-mobile").addClass("hidden");if(classicSessionType==="true"){$("#account-info").find(".user-email").removeClass("hidden");$("#account-info").find(".user-name").text(localStorage.getItem("username"));$("#account-info").find(".user-email p").html(localStorage.getItem("useremail"));$("#account-info").find(".user-glome-key").addClass("hidden");$("#account-info").find(".user-id").html(localStorage.getItem("userid"));$(".sidebar-content").hide();if(!sidebar.isVisible()){sidebar.show()}$("#account-info").show()}if(classicSessionType==="false"){$("#account-info").find(".user-name").text("anon (⌐■_■)");$("#account-info").find(".user-email").addClass("hidden");$("#account-info").find(".user-glome-key p").html(localStorage.getItem("glomekey"));$("#account-info").find(".user-id").html(localStorage.getItem("userid"));$(".sidebar-content").hide();if(!sidebar.isVisible()){sidebar.show()}$("#account-info").show()}}}function showAlert(errorMessage,errorType,closeDelay){if(!errorType||typeof errorType==="undefined"){var errorType="info"}var alert=$('<div class="alert alert-'+errorType+' fade in">').append(errorMessage);$(".alert-container").prepend(alert);if(closeDelay){window.setTimeout(function(){alert.alert("close")},closeDelay)}}$(document).ready(function(){$("#user-tools").on("click","a",function(e){if($(this).hasClass("dropdown-link")){e.preventDefault();bottombar.hide();sidebar.show();$(this.hash).fadeIn().siblings().hide()}});$("#btn-mobile-menu").click(function(e){e.preventDefault();bottombar.hide();sidebar.toggle($("#mobile-menu-dialog").fadeIn().siblings().hide())})});$(document).ready(function(){$(".btn-locate").on("click",function(){sidebar.hide();bottombar.hide();map.locate({setView:true,maxZoom:20})});$("#btn-trashbins").on("click",function(){osmTrashbinLayer=new L.OverPassLayer({query:'(node["amenity"="waste_basket"]({{bbox}});node["amenity"="recycling"]({{bbox}});node["amenity"="waste_disposal"]({{bbox}}););out;'});map.addLayer(osmTrashbinLayer)})});$(document).ready(function(){$(".selectpicker").selectpicker({style:"btn-lg btn-default text-center",size:6})});$(document).ready(function(){$(function(){$("#event-date-time-picker").datetimepicker({minDate:new Date(2015,11,31)})});$("#event-date-time-picker").on("dp.change",function(e){var eventDateTime=e.date.format("DD/MM/YYYY HH:MM");$(".date-time-value").val(eventDateTime)})});$(".sidebar-link").click(function(e){e.preventDefault();$(this.hash).fadeIn().siblings().hide();$("#sidebar").scrollTop=0});$(".menu-backlink").click(function(e){$(".panel-collapse").collapse("hide");$("#sidebar").scrollTop=0;$(this.hash).fadeIn().siblings().hide();e.preventDefault()});$(".btn-cancel").on("click",function(){sidebar.hide();map.removeLayer(marker)});sidebar.on("hide",function(){$(".sidebar-content").hide();$("#sidebar").scrollTop=0;$("form").each(function(){this.reset()});$("input").val("");$(".selectpicker").selectpicker("render");$(".leaflet-draw-edit-edit").removeClass("visible");$(".leaflet-draw-edit-remove").removeClass("visible")});function clearBottomPanelContent(){$(".feature-info").empty();$(".feature-info-confirmed strong").text("0");$("#feature-info-image").attr("src","");$("#feature-info").find(".feature-image-link").attr("href","");$("#feature-info").find(".btn-share").each(function(){$(this).attr("data-url","")})}function login(e){e.preventDefault();var email=$("#login-email").val(),password=$("#login-password").val();$.ajax({type:api.createLogin.method,url:api.createLogin.url(),data:{email:email,password:password},success:function(response){localStorage.setItem("token",response.token);void 0;$("#user-login-dialog").hide();$.ajax({method:api.readUser.method,url:api.readUser.url(),headers:{Authorization:"Bearer "+response.token},success:function(data){localStorage.setItem("classic","true");localStorage.setItem("username",data.user.name);localStorage.setItem("userid",data.user.id);localStorage.setItem("useremail",data.user.email);void 0;void 0;switchSession("login");showAlert("Login successful","success",1500)}})},error:function(response){void 0;showAlert("Failed to log in.","danger",2e3);localStorage.removeItem("token")}})}function logout(){if(!localStorage.token){showAlert("User is already logged out.","info",2e3);localStorage.clear()}localStorage.clear();sidebar.hide();switchSession("logout");showAlert("You are logged out.","info",2e3);return}function registerUser(e){e.preventDefault();var email=$("#register-email").val(),name=$("#register-name").val(),password=$("#register-password").val();$.ajax({type:api.createUser.method,url:api.createUser.url(),data:{email:email,password:password,name:name},success:function(response){localStorage.setItem("token",response.token);void 0;$("#create-account-dialog").hide();$.ajax({method:api.readUser.method,url:api.readUser.url(),headers:{Authorization:"Bearer "+response.token},success:function(data){localStorage.setItem("classic","true");localStorage.setItem("username",data.user.name);localStorage.setItem("userid",data.user.id);localStorage.setItem("useremail",data.user.email);switchSession("login");showAlert("Registration successful, you are now logged in.","success",2e3)}})},error:function(response){void 0;showAlert(response.responseText.substring(2,30),"danger",3500);localStorage.removeItem("token")}})}function glomego(e){void 0;e.preventDefault();$.ajax({type:api.createSoftAccount.method,url:api.createSoftAccount.url(),dataType:"json",success:function(response){void 0;void 0;void 0;var glomeid=response.user.name,authUser=response.user,token=response.token;if(!glomeid||typeof glomeid==="undefined"){void 0;showAlert("Failed to login anonymously. Reload the page and try again.","warning",3e3);return}localStorage.setItem("token",token);localStorage.setItem("glomekey",glomeid);localStorage.setItem("userid",response.user.id);void 0;void 0;void 0;$("#user-login-dialog").hide();$.ajax({method:api.readSoftAccount.method,url:api.readSoftAccount.url(glomeid),headers:{Authorization:"Bearer "+token},dataType:"json",success:function(data){void 0;if(!data||typeof data==="undefined"){return}if(typeof authUser!=="undefined"){localStorage.setItem("classic","false");switchSession("login");showAlert("You are now logged in anonymously.","success",2e3)}}})},error:function(response){void 0;showAlert("Failed to login anonymously. Reload the page and try again.","warning",3e3);localStorage.removeItem("token")}})}function sendGlomeKey(e){e.preventDefault();var glomeKey=$("#glome-key").val();$.ajax({type:"POST",url:"http://api.garbagepla.net/api/glome/",data:{key:glomeKey},success:function(response){localStorage.setItem("token",response.token);void 0;$("#create-account-dialog").hide();switchSession("login");showAlert("Welcome back, anonymous!.","success",2e3);$.ajax({method:"get",url:"http://api.garbagepla.net/api/authenticate/glome",headers:{Authorization:"Bearer "+response.token},success:function(data){void 0;$("#account-info").find(".user-glome-key p").html(data.user.key);$("#account-info").find(".user-email").addClass("hidden");$("#account-info").find(".created-at").html(data.user.created_at);$("#account-info").find(".updated-at").html(data.user.updated_at);$("#account-info").show()}})},error:function(response){void 0;showAlert("Sorry. Key not recognized.","danger",3e3);localStorage.removeItem("token")}})}$(function(){$(".btn-logout").on("click",logout);$(".btn-login").click(login);$("#registration-form").submit(registerUser);$(".btn-glome-go").click(glomego);$(".btn-glome-key-send").click(sendGlomeKey)});L.Map.prototype.panToOffset=function(latlng,offset,options){var x=this.latLngToContainerPoint(latlng).x-offset[0],y=this.latLngToContainerPoint(latlng).y-offset[1],point=this.containerPointToLatLng([x,y]);return this.setView(point,this._zoom,{pan:options})};function _getVerticalOffset(){var vOffset=[0,0];vOffset[1]=-$(window).height()/4;vOffset[0]=0;return vOffset}function _getHorizontalOffset(){var hOffset=[0,0];hOffset[0]=-$(window).height()/4;hOffset[1]=0;return hOffset}function onMapClick(e){if(!sidebar.isVisible()&&!bottombar.isVisible()&&mapZoom>=10&&!$(".dropdown").hasClass("open")&&!$(".leaflet-control-layers").hasClass(".leaflet-control-layers-expanded")){marker=L.marker(e.latlng,{icon:genericMarker,draggable:true}).on("click",onLocalMarkerClick).addTo(map);$(".marker-lat").val(marker._latlng.lat);$(".marker-lng").val(marker._latlng.lng);if($(window).height()>=500){map.panToOffset(marker._latlng,_getHorizontalOffset())}$(".sidebar-content").hide();$("#sidebar").scrollTop=0;sidebar.show($("#create-marker-dialog").show());$(".garbage-range-input").on("change",function(){$(marker._icon).removeClass("marker-generic").addClass("marker-garbage");$(".garbage-range-value").html(this.value);var selectedValue=parseInt($(this).val(),10);switch(selectedValue){case 1:$(marker._icon).removeClass(function(index,css){return(css.match(/(^|\s)marker-color-\S+/g)||[]).join(" ")}).addClass("marker-color-green");break;case 2:$(marker._icon).removeClass(function(index,css){return(css.match(/(^|\s)marker-color-\S+/g)||[]).join(" ")}).addClass("marker-color-limegreen");break;case 3:$(marker._icon).removeClass(function(index,css){return(css.match(/(^|\s)marker-color-\S+/g)||[]).join(" ")}).addClass("marker-color-yellow");break;case 4:$(marker._icon).removeClass(function(index,css){return(css.match(/(^|\s)marker-color-\S+/g)||[]).join(" ")}).addClass("marker-color-gold");break;case 5:$(marker._icon).removeClass(function(index,css){return(css.match(/(^|\s)marker-color-\S+/g)||[]).join(" ")}).addClass("marker-color-orange");break;case 6:$(marker._icon).removeClass(function(index,css){return(css.match(/(^|\s)marker-color-\S+/g)||[]).join(" ")}).addClass("marker-color-orangered");break;case 7:$(marker._icon).removeClass(function(index,css){return(css.match(/(^|\s)marker-color-\S+/g)||[]).join(" ")}).addClass("marker-color-red");break;case 8:$(marker._icon).removeClass(function(index,css){return(css.match(/(^|\s)marker-color-\S+/g)||[]).join(" ")}).addClass("marker-color-darkred");break;case 9:$(marker._icon).removeClass(function(index,css){return(css.match(/(^|\s)marker-color-\S+/g)||[]).join(" ")}).addClass("marker-color-purple");break;case 10:$(marker._icon).removeClass(function(index,css){return(css.match(/(^|\s)marker-color-\S+/g)||[]).join(" ")}).addClass("marker-color-black");break;default:$(marker._icon).removeClass(function(index,css){return(css.match(/(^|\s)marker-color-\S+/g)||[]).join(" ")}).addClass("marker-color-unknown");break}});marker.on("dragend",function(event){var newPos=event.target.getLatLng();void 0;$(".marker-lat").val(newPos.lat);$(".marker-lng").val(newPos.lng)});map.on("draw:drawstart",function(e){map.removeLayer(marker)})}else{bottombar.hide();sidebar.hide();$(".dropdown").removeClass("open");$(".leaflet-control-layers").removeClass(".leaflet-control-layers-expanded")}}map.on("click",onMapClick);function onLocalMarkerClick(e){bottombar.hide();marker=this;map.panToOffset(marker._latlng,_getHorizontalOffset());void 0;marker.on("dragend",function(event){var newPos=event.target.getLatLng();$(".marker-lat").val(newPos.lat);$(".marker-lng").val(newPos.lng)});$("#sidebar").scrollTop=0;$(".sidebar-content").hide();sidebar.show($("#create-marker-dialog").fadeIn())}function editFeature(obj){bottombar.hide();if(obj.options.type==="marker_garbage"){sidebar.show($("#create-garbage-dialog").show().siblings().hide())}if(obj.options.type==="marker_cleaning"){sidebar.show($("#create-cleaning-dialog").show().siblings().hide())}if(obj.options.type==="polyline_litter"){sidebar.show($("#create-litter-dialog").show().siblings().hide())}if(obj.options.type==="polygon_area"){sidebar.show($("#create-area-dialog").show().siblings().hide())}}setTimeout(function(){$("div.marker-generic").remove();sidebar.hide()},4e5);$(function(){$(".image-uploader").fileupload({headers:{Authorization:"Client-ID "+"Imgur Client ID"},url:"https://api.imgur.com/3/image",dataType:"json",progressall:function(e,data){var progress=parseInt(data.loaded/data.total*100,10);$(".progress").removeClass("hidden");$(".progress-bar").css("width",progress+"%")},done:function(e,data){$(e.target).parent().next().val(data.result.data.link);$(".progress").addClass("hidden").delay(200)}});$(".btn-image-uploader").click(function(){$(this).next().trigger("click")})});window.token="eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOjYsImlzcyI6Imh0dHA6XC9cL2FwaS5nYXJiYWdlcGxhLm5ldFwvYXBpXC9hdXRoZW50aWNhdGUiLCJpYXQiOiIxNDQ2OTAxNTcxIiwiZXhwIjoiMTQ0NjkwNTE3MSIsIm5iZiI6IjE0NDY5MDE1NzEiLCJqdGkiOiJhMzljOTg1ZDZmNWNjNmU4MGNlMmQzOWZjODg5NWM1YSJ9.R28VF7VI1S3-PpvaG6cjpyxpygvQCB0JXF5oQ27TxCw";$(function(){$(".form-garbage").on("submit",function(event){event.preventDefault();var that=this,garbageType=[],tags=[],garbageTodo=[],garbageAmount,lat,lng,image_url,note;$(this).find(".selectpicker.garbage-type-select option:selected").each(function(index,value){garbageType.push($(value).val())});$(this).find(".selectpicker.garbage-todo-select option:selected").each(function(index,value){garbageTodo.push($(value).val())});garbageAmout=$("input[class=garbage-range-input]").val();note=$(this).find(".garbage-note").val();image_url=$(this).find(".garbage-image-hidden-value").val();tags=$(this).find(".garbage-tags").tagsinput("items");lat=$(this).find(".marker-lat").val();lng=$(this).find(".marker-lng").val();setTimeout(function(){var useToken=localStorage.getItem("token")||window.token;$.ajax({method:api.createTrash.method,url:api.createTrash.url(),headers:{Authorization:"Bearer"+useToken},data:{lat:lat,lng:lng,amount:garbageAmount,types:garbageType.join(),todo:garbageTodo,image_url:image_url,tag:tags.join(),note:note,featuretype:"marker_garbage"},success:function(data){void 0;showAlert("Marker saved successfully!","success",1500);if(garbageAmount>8){showAlert("That's a lot of trash, we opened a 311 ticket!","warning",3e3)}sidebar.hide("slow");map.removeLayer(marker);loadGarbageMarkers()},error:function(response){showAlert("Something went wrong, HTTP error "+response.status,"danger",2500);void 0;sidebar.hide();map.removeLayer(marker)}})},100)})});$(function(){$(".form-cleaning").on("submit",function(event){event.preventDefault();var that=this,tags=[],eventRecurrence=[],dateTime,lat,lng;dateTime=$(".date-time-value").val();tags=$(this).find(".cleaning-tags").tagsinput("items");lat=$(this).find(".cleaning-lat").val();lng=$(this).find(".cleaning-lng").val();$(this).find(".selectpicker.cleaning-recurrent-select option:selected").each(function(index,value){
eventRecurrence.push($(value).val())});setTimeout(function(){var useToken=localStorage.getItem("token")||window.token;$.ajax({method:api.createCleaning.method,url:api.createCleaning.url(),headers:{Authorization:"Bearer"+useToken},data:{lat:lat,lng:lng,date:dateTime,recurrence:eventRecurrence,tag:tags.join(),featuretype:"marker_cleaning"},success:function(data){$(marker._icon).removeClass("marker-color-gray marker-generic").addClass("marker-cleaning marker-color-coral");void 0;showAlert("Cleaning event saved successfully!","success",2e3);sidebar.hide("slow");loadCleaningMarkers();map.removeLayer(marker)},error:function(err){void 0;showAlert("Sorry, failed to save the event.","danger",3e3);sidebar.hide();map.removeLayer(marker)}})},100)})});$(function(){$(".form-litter").on("submit",function(event){event.preventDefault();var that=this,litterType=[],tags=[],litterAmount,latlngs,image_url,length,geojson_data,wms_url,note;latlngs=$(this).find(".litter-latlngs").val();$(this).find(".selectpicker.litter-type-select option:selected").each(function(index,value){litterType.push($(value).val())});tags=$(this).find(".litter-tags").tagsinput("items");litterAmount=$("input[class=litter-range-input]").val();length=$(this).find(".litter-path-length").val();image_url=$(this).find(".litter-image-hidden-value").val();note=$("input[class=litter-note]").val();wms_url=$("input[class=litter-wms-url]").val();geojson_data=$("input[class=litter-geojson-data]").val();void 0;void 0;void 0;void 0;void 0;void 0;setTimeout(function(){var useToken=localStorage.getItem("token")||window.token;$.ajax({method:api.createShape.method,url:api.createShape.url(),headers:{Authorization:"Bearer"+useToken},data:{latlngs:latlngs.join(),amount:litterAmount,types:litterType.join(),image_url:image_url,length:length,wms_url:wms_url,geojson_data:geojson_data,tag:tags.join(),featuretype:"polyline_litter"},success:function(data){void 0;showAlert("Litter saved successfully!","success",1500);sidebar.hide("slow")},error:function(err){void 0;showAlert("Sorry, failed to save the litter.","danger",2e3);sidebar.hide();map.removeLayer(polylineLayer)}})},200)})});$(function(){$(".form-area").on("submit",function(event){event.preventDefault();var that=this,tags=[],latlngs,note,secret,players,title,contact;latlngs=$(this).find(".area-latlngs").val();title=$(this).find(".area-title").val();note=$(this).find(".area-note").val();secret=$(this).find(".area-secret").val();contact=$(this).find(".area-contact").val();players=$(this).find(".area-players").val();tags=$(this).find(".area-tags").tagsinput("items");void 0;void 0;void 0;setTimeout(function(){var useToken=localStorage.getItem("token")||window.token;$.ajax({method:api.createShape.method,url:api.createShape.url(),headers:{Authorization:"Bearer"+useToken},data:{type:"polygon",latlngs:latlngs.join(),players:players.join(),note:note,contact:contact,secret:secret,title:title,tag:tags.join(),featuretype:"polygon_area"},success:function(data){void 0;showAlert("Area saved successfully!","success",1500);sidebar.hide("slow")},error:function(err){void 0;showAlert("Sorry, failed to save the area.","danger",2e3);sidebar.hide();map.removeLayer(polygonLayer)}})},200)})});editableLayerGroup=new L.FeatureGroup;var drawControl=new L.Control.Draw({position:"topright",draw:{circle:false,rectangle:false,marker:false},edit:{featureGroup:editableLayerGroup,remove:true}});map.addControl(drawControl);map.on("draw:drawstart",function(e){var type=e.layerType,layer=e.layer;$(".btn-draw").addClass("disabled")});map.on("draw:editstart",function(e){map.off("click",onMapClick);$(".btn-draw").addClass("disabled")});map.on("draw:editstop",function(e){$(".btn-draw").removeClass("disabled");$(".leaflet-draw-edit-edit").removeClass("visible");$(".leaflet-draw-edit-remove").removeClass("visible")});map.on("draw:deletestart",function(e){map.off("click",onMapClick);$(".btn-draw").addClass("disabled")});map.on("draw:deletestop",function(e){map.on("click",onMapClick);$(".btn-draw").removeClass("disabled");$(".leaflet-draw-edit-edit").removeClass("visible");$(".leaflet-draw-edit-remove").removeClass("visible")});map.on("draw:drawstop",function(){map.off("click",onMapClick);map.on("click",onMapClick);$(".btn-draw").removeClass("disabled")});map.on("draw:created",function(e){var latlngs=e.layer.getLatLngs().toString().replace(/\(/g,"[").replace(/\)/g,"]").replace(/LatLng/g,"");if(e.layerType==="polyline"){map.fitBounds(e.layer.getBounds(),{paddingBottomRight:[300,0]});$(".form-litter .litter-latlngs").val(latlngs);void 0;$(".litter-range-input").on("change",function(){$(".litter-range-value").html(this.value);var selectedValue=parseInt($(this).val(),10);switch(selectedValue){case 1:e.layer.setStyle({color:"green"});break;case 2:e.layer.setStyle({color:"limegreen"});break;case 3:e.layer.setStyle({color:"yellow"});break;case 4:e.layer.setStyle({color:"gold"});break;case 5:e.layer.setStyle({color:"orange"});break;case 6:e.layer.setStyle({color:"orangered"});break;case 7:e.layer.setStyle({color:"red"});break;case 8:e.layer.setStyle({color:"darkred"});break;case 9:e.layer.setStyle({color:"purple"});break;case 10:e.layer.setStyle({color:"black"});break;default:e.layer.resetStyle();break}});editableLayerGroup.addLayer(e.layer);map.addLayer(editableLayerGroup);$(".btn-cancel").on("click",function(){$(".leaflet-draw-edit-edit").removeClass("visible");$(".leaflet-draw-edit-remove").removeClass("visible");map.removeLayer(e.layer)})}if(e.layerType==="polygon"){map.fitBounds(e.layer.getBounds(),{paddingBottomRight:[300,0]});$(".form-area .area-latlngs").val(latlngs);editableLayerGroup.addLayer(e.layer);map.addLayer(editableLayerGroup);$(".btn-cancel").on("click",function(){$(".leaflet-draw-edit-edit").removeClass("visible");$(".leaflet-draw-edit-remove").removeClass("visible");map.removeLayer(e.layer)})}map.on("click",onMapClick);$(".btn-draw").removeClass("disabled")});map.on("draw:edited",function(e){var layers=e.layers;layers.eachLayer(function(layer){var type=e.layerType,currentlayer=e.layer;if(type==="polyline"){return"polyline"}if(type==="polygon"){return"polygon"}});map.on("click",onMapClick)});$(".btn-draw-polyline").on("click",function(){map.off("click",onMapClick);$(".leaflet-draw-edit-edit").addClass("visible");$(".leaflet-draw-edit-remove").addClass("visible");new L.Draw.Polyline(map,{allowIntersection:false,drawError:{color:"#cc0000",timeout:2e3},metric:true,clickable:true,shapeOptions:{color:"#A9A9A9",weight:10,opacity:.5,smoothFactor:2}}).enable()});$(".btn-draw-polygon").on("click",function(){map.off("click",onMapClick);$(".leaflet-draw-edit-edit").addClass("visible");$(".leaflet-draw-edit-remove").addClass("visible");new L.Draw.Polygon(map,{shapeOptions:{color:"#dd55ff",weight:5,opacity:.5,smoothFactor:2},showArea:true,metric:true,clickable:true,allowIntersection:false,drawError:{color:"#cc0000",timeout:2e3}}).enable()});